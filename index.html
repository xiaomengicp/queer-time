<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¥¿æ¥é£Ÿ å›°æ¥çœ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 300;
            margin-bottom: 10px;
            color: #a8d8ea;
            letter-spacing: 2px;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 0.8rem;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            color: #888;
        }

        .stat-value {
            color: #a8d8ea;
        }

        .creature-container {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .creature {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #a8d8ea, #5e9ecf, #3d5a80);
            box-shadow: 
                0 0 60px rgba(168, 216, 234, 0.4),
                inset 0 0 30px rgba(255, 255, 255, 0.1);
            animation: float 4s ease-in-out infinite, breathe 3s ease-in-out infinite;
            position: relative;
            transition: all 0.5s ease;
        }

        /* æ´»åŠ¨çŠ¶æ€é¢œè‰² */
        .creature.working { background: radial-gradient(circle at 30% 30%, #ffd93d, #f39c12, #d68910); box-shadow: 0 0 60px rgba(255, 217, 61, 0.4); }
        .creature.resting { background: radial-gradient(circle at 30% 30%, #a29bfe, #6c5ce7, #5849a6); box-shadow: 0 0 60px rgba(162, 155, 254, 0.4); }
        .creature.creating { background: radial-gradient(circle at 30% 30%, #fd79a8, #e84393, #c23672); box-shadow: 0 0 60px rgba(253, 121, 168, 0.4); }
        .creature.exercising { background: radial-gradient(circle at 30% 30%, #55efc4, #00b894, #00a381); box-shadow: 0 0 60px rgba(85, 239, 196, 0.4); }
        .creature.socializing { background: radial-gradient(circle at 30% 30%, #fdcb6e, #f39c12, #d68910); box-shadow: 0 0 60px rgba(253, 203, 110, 0.4); }
        .creature.reading { background: radial-gradient(circle at 30% 30%, #81ecec, #00cec9, #00a8a3); box-shadow: 0 0 60px rgba(129, 236, 236, 0.4); }

        /* ç²¾åŠ›ä½ */
        .creature.tired {
            background: radial-gradient(circle at 30% 30%, #636e72, #535c68, #3d4145);
            box-shadow: 0 0 30px rgba(99, 110, 114, 0.3);
            animation: float 6s ease-in-out infinite, breathe 5s ease-in-out infinite;
        }

        /* è¿æ¥ä½+ç²¾åŠ›ä½ï¼šçƒ¦èº */
        .creature.upset {
            animation: float 4s ease-in-out infinite, breathe 3s ease-in-out infinite, shake 0.3s ease-in-out infinite;
        }

        /* è¿æ¥é«˜+ç²¾åŠ›é«˜ï¼šå‘å…‰ */
        .creature.happy {
            box-shadow: 0 0 80px rgba(168, 216, 234, 0.6), 0 0 120px rgba(168, 216, 234, 0.3);
        }

        .eyes {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 20px;
        }

        .eye {
            width: 12px;
            height: 12px;
            background: #1a1a2e;
            border-radius: 50%;
            animation: blink 4s ease-in-out infinite;
            transition: all 0.3s ease;
        }

        .creature.tired .eye {
            height: 6px;
            border-radius: 6px;
        }

        .creature.upset .eye {
            transform: rotate(-10deg);
        }

        /* å°åŠ¨ä½œ */
        .creature.looking-around .eye:first-child {
            transform: translateX(-5px);
        }
        .creature.looking-around .eye:last-child {
            transform: translateX(5px);
        }

        .creature.stretching {
            transform: scaleY(1.15) scaleX(0.9);
        }

        .creature.noticed-you .eye {
            width: 16px !important;
            height: 16px !important;
            transition: all 0.2s ease;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes blink {
            0%, 45%, 55%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        @keyframes quickBlink {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.1); }
        }

        .status-message {
            font-size: 0.9rem;
            color: #a8d8ea;
            margin-bottom: 15px;
            text-align: center;
            min-height: 24px;
            transition: all 0.3s ease;
        }

        .timer-display {
            font-size: 3rem;
            font-weight: 200;
            margin-bottom: 15px;
            font-variant-numeric: tabular-nums;
            color: #e8e8e8;
        }

        .current-activity {
            font-size: 1rem;
            color: #a8d8ea;
            margin-bottom: 15px;
        }

        .activities {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            width: 100%;
            max-width: 360px;
        }

        .activity-btn {
            padding: 15px 10px;
            border: 1px solid rgba(168, 216, 234, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: #e8e8e8;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .activity-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(168, 216, 234, 0.5);
        }

        .activity-btn.active {
            background: rgba(168, 216, 234, 0.2);
            border-color: #a8d8ea;
        }

        .activity-btn.work { border-color: #ffd93d; }
        .activity-btn.work.active { background: rgba(255, 217, 61, 0.2); }
        .activity-btn.rest { border-color: #a29bfe; }
        .activity-btn.rest.active { background: rgba(162, 155, 254, 0.2); }
        .activity-btn.create { border-color: #fd79a8; }
        .activity-btn.create.active { background: rgba(253, 121, 168, 0.2); }
        .activity-btn.exercise { border-color: #55efc4; }
        .activity-btn.exercise.active { background: rgba(85, 239, 196, 0.2); }
        .activity-btn.social { border-color: #fdcb6e; }
        .activity-btn.social.active { background: rgba(253, 203, 110, 0.2); }
        .activity-btn.read { border-color: #81ecec; }
        .activity-btn.read.active { background: rgba(129, 236, 236, 0.2); }

        .timer-settings {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .timer-input {
            width: 60px;
            padding: 8px;
            border: 1px solid rgba(168, 216, 234, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #e8e8e8;
            text-align: center;
            font-size: 1rem;
        }

        .timer-input:focus {
            outline: none;
            border-color: #a8d8ea;
        }

        .timer-label {
            color: #a8d8ea;
            font-size: 0.9rem;
        }

        .control-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .start-btn {
            background: linear-gradient(135deg, #a8d8ea, #5e9ecf);
            color: #1a1a2e;
        }

        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(168, 216, 234, 0.4);
        }

        .stop-btn {
            background: linear-gradient(135deg, #ff7675, #d63031);
            color: #fff;
        }

        .stop-btn:hover {
            transform: scale(1.05);
        }

        .balance-container {
            width: 100%;
            max-width: 360px;
            margin-top: 15px;
        }

        .balance-title {
            font-size: 0.85rem;
            color: #a8d8ea;
            margin-bottom: 10px;
        }

        .balance-bars {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .balance-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .balance-label {
            width: 50px;
            font-size: 0.75rem;
            color: #888;
        }

        .balance-bar {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .balance-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .balance-fill.work { background: #ffd93d; }
        .balance-fill.rest { background: #a29bfe; }
        .balance-fill.create { background: #fd79a8; }
        .balance-fill.exercise { background: #55efc4; }
        .balance-fill.social { background: #fdcb6e; }
        .balance-fill.read { background: #81ecec; }

        .balance-time {
            width: 50px;
            font-size: 0.75rem;
            color: #888;
            text-align: right;
        }

        .bottom-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .reset-btn {
            padding: 8px 20px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            color: #888;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .reset-btn:hover {
            border-color: rgba(255, 255, 255, 0.4);
            color: #aaa;
        }

        /* è¡¥è®°å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal {
            background: #1a1a2e;
            border: 1px solid rgba(168, 216, 234, 0.3);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 300px;
        }

        .modal-title {
            font-size: 1.1rem;
            color: #a8d8ea;
            margin-bottom: 8px;
        }

        .modal-desc {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 20px;
        }

        .modal-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .modal-row label {
            color: #888;
            font-size: 0.9rem;
            width: 50px;
        }

        .modal-row select,
        .modal-row input {
            flex: 1;
            padding: 8px;
            border: 1px solid rgba(168, 216, 234, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #e8e8e8;
            font-size: 0.9rem;
        }

        .modal-row select:focus,
        .modal-row input:focus {
            outline: none;
            border-color: #a8d8ea;
        }

        .modal-row span {
            color: #888;
            font-size: 0.9rem;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .modal-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .modal-btn.confirm {
            background: linear-gradient(135deg, #a8d8ea, #5e9ecf);
            color: #1a1a2e;
        }

        /* æé†’éŸ³æ•ˆæç¤º */
        .timer-done {
            animation: pulse 0.5s ease-in-out 3;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body>
    <h1>é¥¿æ¥é£Ÿ å›°æ¥çœ </h1>
    
    <div class="stats-bar">
        <div class="stat">
            <span class="stat-label">ç²¾åŠ›</span>
            <span class="stat-value" id="energy-display">50%</span>
        </div>
        <div class="stat">
            <span class="stat-label">è¿æ¥</span>
            <span class="stat-value" id="bonding-display">0%</span>
        </div>
    </div>
    
    <div class="creature-container" id="creature-container">
        <div class="creature" id="creature">
            <div class="eyes">
                <div class="eye"></div>
                <div class="eye"></div>
            </div>
        </div>
    </div>
    
    <div class="status-message" id="status-message">ä½ æ¥äº†</div>
    
    <div class="timer-display" id="timer-display">00:00</div>
    
    <div class="current-activity" id="current-activity"></div>
    
    <div class="activities" id="activities">
        <button class="activity-btn work" data-type="work">å·¥ä½œ</button>
        <button class="activity-btn rest" data-type="rest">ä¼‘æ¯</button>
        <button class="activity-btn create" data-type="create">åˆ›é€ </button>
        <button class="activity-btn exercise" data-type="exercise">è¿åŠ¨</button>
        <button class="activity-btn social" data-type="social">ç¤¾äº¤</button>
        <button class="activity-btn read" data-type="read">é˜…è¯»</button>
    </div>
    
    <div class="timer-settings" id="timer-settings">
        <span class="timer-label">è®¾å®šæ—¶é—´ï¼š</span>
        <input type="number" class="timer-input" id="timer-input" placeholder="åˆ†é’Ÿ" min="1" max="180">
        <span class="timer-label">åˆ†é’Ÿ</span>
    </div>
    
    <div>
        <button class="control-btn start-btn" id="start-btn">å¼€å§‹</button>
        <button class="control-btn stop-btn" id="stop-btn" style="display: none;">ç»“æŸ</button>
    </div>
    
    <div class="balance-container">
        <div class="balance-title">ä»Šæ—¥å¹³è¡¡</div>
        <div class="balance-bars" id="balance-bars">
            <div class="balance-row">
                <span class="balance-label">å·¥ä½œ</span>
                <div class="balance-bar"><div class="balance-fill work" id="bar-work"></div></div>
                <span class="balance-time" id="time-work">0åˆ†</span>
            </div>
            <div class="balance-row">
                <span class="balance-label">ä¼‘æ¯</span>
                <div class="balance-bar"><div class="balance-fill rest" id="bar-rest"></div></div>
                <span class="balance-time" id="time-rest">0åˆ†</span>
            </div>
            <div class="balance-row">
                <span class="balance-label">åˆ›é€ </span>
                <div class="balance-bar"><div class="balance-fill create" id="bar-create"></div></div>
                <span class="balance-time" id="time-create">0åˆ†</span>
            </div>
            <div class="balance-row">
                <span class="balance-label">è¿åŠ¨</span>
                <div class="balance-bar"><div class="balance-fill exercise" id="bar-exercise"></div></div>
                <span class="balance-time" id="time-exercise">0åˆ†</span>
            </div>
            <div class="balance-row">
                <span class="balance-label">ç¤¾äº¤</span>
                <div class="balance-bar"><div class="balance-fill social" id="bar-social"></div></div>
                <span class="balance-time" id="time-social">0åˆ†</span>
            </div>
            <div class="balance-row">
                <span class="balance-label">é˜…è¯»</span>
                <div class="balance-bar"><div class="balance-fill read" id="bar-read"></div></div>
                <span class="balance-time" id="time-read">0åˆ†</span>
            </div>
        </div>
    </div>
    
    <div class="bottom-buttons">
        <button class="reset-btn" id="reset-btn">é‡ç½®ä»Šæ—¥</button>
        <button class="reset-btn" id="log-btn">è¡¥è®°</button>
        <button class="reset-btn" id="export-btn">å¯¼å‡ºæ•°æ®</button>
    </div>
    
    <!-- è¡¥è®°å¼¹çª— -->
    <div class="modal-overlay" id="log-modal" style="display: none;">
        <div class="modal">
            <div class="modal-title">è¡¥è®°ä¸€æ®µæ—¶é—´</div>
            <div class="modal-desc">åªè®°å½•æ•°æ®ï¼Œä¸å¢åŠ è¿æ¥å€¼</div>
            <div class="modal-row">
                <label>æ´»åŠ¨ï¼š</label>
                <select id="log-activity">
                    <option value="work">å·¥ä½œ</option>
                    <option value="rest">ä¼‘æ¯</option>
                    <option value="create">åˆ›é€ </option>
                    <option value="exercise">è¿åŠ¨</option>
                    <option value="social">ç¤¾äº¤</option>
                    <option value="read">é˜…è¯»</option>
                </select>
            </div>
            <div class="modal-row">
                <label>æ—¶é•¿ï¼š</label>
                <input type="number" id="log-minutes" placeholder="åˆ†é’Ÿ" min="1" max="480">
                <span>åˆ†é’Ÿ</span>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="log-cancel">å–æ¶ˆ</button>
                <button class="modal-btn confirm" id="log-confirm">è®°å½•</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== çŠ¶æ€ ====================
        let selectedActivity = null;
        let isRunning = false;
        let startTime = null;
        let timerInterval = null;
        let targetMinutes = null;
        let idleActionInterval = null;

        // ==================== æ•°æ®å­˜å‚¨ ====================
        const today = new Date().toDateString();
        
        // è¯»å–æ‰€æœ‰å†å²æ•°æ®
        let allData = JSON.parse(localStorage.getItem('queertime-all') || '{}');
        
        // ä»Šæ—¥æ•°æ®
        if (!allData[today]) {
            allData[today] = { work: 0, rest: 0, create: 0, exercise: 0, social: 0, read: 0 };
        }
        let todayLogs = allData[today];

        // ç²¾åŠ›å’Œè¿æ¥å€¼
        let state = JSON.parse(localStorage.getItem('queertime-state') || '{}');
        if (!state.energy) state.energy = 50;
        if (!state.bonding) state.bonding = 0;
        if (!state.lastVisit) state.lastVisit = Date.now();

        // ==================== DOM ====================
        const creature = document.getElementById('creature');
        const creatureContainer = document.getElementById('creature-container');
        const statusMessage = document.getElementById('status-message');
        const timerDisplay = document.getElementById('timer-display');
        const currentActivity = document.getElementById('current-activity');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const timerInput = document.getElementById('timer-input');
        const timerSettings = document.getElementById('timer-settings');
        const resetBtn = document.getElementById('reset-btn');
        const exportBtn = document.getElementById('export-btn');
        const energyDisplay = document.getElementById('energy-display');
        const bondingDisplay = document.getElementById('bonding-display');

        // ==================== åˆå§‹åŒ– ====================
        
        // æ£€æŸ¥ç¦»å¼€äº†å¤šä¹…ï¼Œè¿æ¥å€¼ä¸‹é™
        const timeSinceLastVisit = (Date.now() - state.lastVisit) / 1000 / 60 / 60; // å°æ—¶
        if (timeSinceLastVisit > 6) {
            // è¶…è¿‡6å°æ—¶æ²¡æ¥ï¼Œè¿æ¥ä¸‹é™
            const decrease = Math.min(state.bonding, Math.floor(timeSinceLastVisit * 2));
            state.bonding = Math.max(0, state.bonding - decrease);
        }
        state.lastVisit = Date.now();
        saveState();

        updateDisplay();
        updateBalanceBars();
        updateCreatureState();
        startIdleActions();

        // æ£€æŸ¥æ˜¯å¦æœ‰æœªå®Œæˆçš„æ´»åŠ¨
        const ongoing = JSON.parse(localStorage.getItem('queertime-ongoing'));
        if (ongoing && ongoing.startTime) {
            const elapsedMinutes = Math.floor((Date.now() - ongoing.startTime) / 1000 / 60);
            if (elapsedMinutes < 480) { // å°‘äº8å°æ—¶æ‰æ¢å¤
                // æ¢å¤æ´»åŠ¨
                selectedActivity = ongoing.activity;
                startTime = ongoing.startTime;
                targetMinutes = ongoing.targetMinutes;
                isRunning = true;
                
                // æ›´æ–°UI
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
                timerSettings.style.display = 'none';
                
                // é«˜äº®å¯¹åº”æŒ‰é’®
                document.querySelector(`.activity-btn.${ongoing.activity === 'read' ? 'read' : ongoing.activity}`).classList.add('active');
                
                updateCreatureActivity(selectedActivity);
                const activityNames = { work: 'å·¥ä½œ', rest: 'ä¼‘æ¯', create: 'åˆ›é€ ', exercise: 'è¿åŠ¨', social: 'ç¤¾äº¤', read: 'é˜…è¯»' };
                currentActivity.textContent = `æ­£åœ¨${activityNames[selectedActivity]}...`;
                statusMessage.textContent = `æ¬¢è¿å›æ¥ï¼Œç»§ç»­${activityNames[selectedActivity]}ä¸­`;
                
                timerInterval = setInterval(updateTimer, 1000);
                updateTimer(); // ç«‹å³æ›´æ–°ä¸€æ¬¡æ˜¾ç¤º
            } else {
                // è¶…è¿‡8å°æ—¶ï¼Œæ¸…é™¤
                localStorage.removeItem('queertime-ongoing');
            }
        }

        // ç‚¹å‡»å® ç‰©
        creatureContainer.addEventListener('click', () => {
            // ç‚¹å‡»æœ¬èº«å°±æ˜¯è¿æ¥ï¼Œä¸éœ€è¦åŠ æ•°å€¼
            
            // å®ƒæ³¨æ„åˆ°ä½ äº†
            creature.classList.add('noticed-you');
            statusMessage.textContent = getClickResponse();
            
            setTimeout(() => {
                creature.classList.remove('noticed-you');
                updateCreatureState();
            }, 1000);
        });

        // ==================== æ´»åŠ¨æŒ‰é’® ====================
        document.querySelectorAll('.activity-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (isRunning) return;
                document.querySelectorAll('.activity-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedActivity = btn.dataset.type;
            });
        });

        // ==================== å¼€å§‹/ç»“æŸ ====================
        startBtn.addEventListener('click', () => {
            if (!selectedActivity) {
                statusMessage.textContent = 'é€‰æ‹©ä¸€ä¸ªæ´»åŠ¨å§';
                return;
            }
            
            isRunning = true;
            startTime = Date.now();
            targetMinutes = timerInput.value ? parseInt(timerInput.value) : null;
            
            // ä¿å­˜è¿›è¡Œä¸­çš„æ´»åŠ¨ï¼Œé˜²æ­¢é¡µé¢è¢«å…³é—­
            localStorage.setItem('queertime-ongoing', JSON.stringify({
                activity: selectedActivity,
                startTime: startTime,
                targetMinutes: targetMinutes
            }));
            
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            timerSettings.style.display = 'none';
            
            updateCreatureActivity(selectedActivity);
            
            const activityNames = { work: 'å·¥ä½œ', rest: 'ä¼‘æ¯', create: 'åˆ›é€ ', exercise: 'è¿åŠ¨', social: 'ç¤¾äº¤', read: 'é˜…è¯»' };
            currentActivity.textContent = `æ­£åœ¨${activityNames[selectedActivity]}...`;
            statusMessage.textContent = getActivityMessage(selectedActivity);
            
            timerInterval = setInterval(updateTimer, 1000);
        });

        stopBtn.addEventListener('click', () => {
            endActivity();
        });

        // ==================== é‡ç½®å’Œå¯¼å‡º ====================
        resetBtn.addEventListener('click', () => {
            if (confirm('ç¡®å®šè¦é‡ç½®ä»Šæ—¥è®°å½•å—ï¼Ÿ')) {
                todayLogs = { work: 0, rest: 0, create: 0, exercise: 0, social: 0, read: 0 };
                allData[today] = todayLogs;
                localStorage.setItem('queertime-all', JSON.stringify(allData));
                updateBalanceBars();
                updateCreatureState();
            }
        });

        exportBtn.addEventListener('click', () => {
            const exportData = {
                history: allData,
                state: state,
                exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `queer-time-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // ==================== è¡¥è®°åŠŸèƒ½ ====================
        const logModal = document.getElementById('log-modal');
        const logBtn = document.getElementById('log-btn');
        const logCancel = document.getElementById('log-cancel');
        const logConfirm = document.getElementById('log-confirm');
        const logActivity = document.getElementById('log-activity');
        const logMinutes = document.getElementById('log-minutes');

        logBtn.addEventListener('click', () => {
            if (isRunning) {
                statusMessage.textContent = 'å…ˆç»“æŸå½“å‰æ´»åŠ¨';
                return;
            }
            logModal.style.display = 'flex';
        });

        logCancel.addEventListener('click', () => {
            logModal.style.display = 'none';
            logMinutes.value = '';
        });

        logConfirm.addEventListener('click', () => {
            const activity = logActivity.value;
            const minutes = parseInt(logMinutes.value);
            
            if (!minutes || minutes < 1) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é•¿');
                return;
            }
            
            // åªè®°å½•æ•°æ®ï¼Œä¸å¢åŠ è¿æ¥å€¼
            todayLogs[activity] += minutes;
            allData[today] = todayLogs;
            localStorage.setItem('queertime-all', JSON.stringify(allData));
            
            // æ›´æ–°æ˜¾ç¤º
            updateBalanceBars();
            
            // å…³é—­å¼¹çª—
            logModal.style.display = 'none';
            logMinutes.value = '';
            
            statusMessage.textContent = 'å·²è¡¥è®°';
            setTimeout(() => updateCreatureState(), 1500);
        });

        // ç‚¹å‡»é®ç½©å…³é—­
        logModal.addEventListener('click', (e) => {
            if (e.target === logModal) {
                logModal.style.display = 'none';
                logMinutes.value = '';
            }
        });

        // ==================== æ ¸å¿ƒå‡½æ•° ====================
        
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            // å®šæ—¶åˆ°äº†
            if (targetMinutes && minutes >= targetMinutes) {
                playNotification();
                endActivity();
            }
        }

        function endActivity() {
            if (!isRunning) return;
            
            clearInterval(timerInterval);
            
            // æ¸…é™¤è¿›è¡Œä¸­æ´»åŠ¨çš„ä¿å­˜
            localStorage.removeItem('queertime-ongoing');
            
            // è®¡ç®—æ—¶é—´
            const elapsedMinutes = Math.max(1, Math.floor((Date.now() - startTime) / 1000 / 60));
            
            // è®°å½•æ´»åŠ¨
            todayLogs[selectedActivity] += elapsedMinutes;
            allData[today] = todayLogs;
            localStorage.setItem('queertime-all', JSON.stringify(allData));
            
            // æ›´æ–°ç²¾åŠ›å’Œè¿æ¥
            updateEnergyAndBonding(selectedActivity, elapsedMinutes);
            
            // é‡ç½®UI
            isRunning = false;
            startTime = null;
            targetMinutes = null;
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            timerSettings.style.display = 'flex';
            timerDisplay.textContent = '00:00';
            currentActivity.textContent = '';
            timerInput.value = '';
            
            document.querySelectorAll('.activity-btn').forEach(b => b.classList.remove('active'));
            selectedActivity = null;
            
            updateBalanceBars();
            updateDisplay();
            updateCreatureState();
        }

        function updateEnergyAndBonding(activity, minutes) {
            // è®¡ç®—æ´»åŠ¨å¤šæ ·æ€§
            const types = ['work', 'rest', 'create', 'exercise', 'social', 'read'];
            const activeTypes = types.filter(t => todayLogs[t] > 0).length;
            const total = types.reduce((sum, t) => sum + todayLogs[t], 0);
            
            // è®¡ç®—éä¼‘æ¯æ´»åŠ¨ä¸­å·¥ä½œçš„å æ¯”
            const nonRestTotal = total - todayLogs.rest;
            const workRatio = nonRestTotal > 0 ? todayLogs.work / nonRestTotal : 0;
            
            // ç²¾åŠ›å˜åŒ–
            if (activity === 'rest') {
                // ä¼‘æ¯æ€»æ˜¯æ¢å¤ç²¾åŠ›
                state.energy = Math.min(100, state.energy + Math.floor(minutes / 2));
            } else if (activity === 'exercise') {
                // è¿åŠ¨ä¹Ÿæ¢å¤ä¸€ç‚¹ç²¾åŠ›
                state.energy = Math.min(100, state.energy + Math.floor(minutes / 4));
            } else if (activeTypes >= 3) {
                // å¤šæ ·æ€§å¥½ï¼Œç²¾åŠ›ç»´æŒï¼Œè½»å¾®ä¸Šå‡
                state.energy = Math.min(100, state.energy + Math.floor(minutes / 8));
            } else if (activeTypes === 1 && total > 60) {
                // å•ä¸€æ´»åŠ¨è¶…è¿‡60åˆ†é’Ÿæ‰å¼€å§‹æ¶ˆè€—
                state.energy = Math.max(0, state.energy - Math.floor(minutes / 5));
            }
            // å…¶ä»–æƒ…å†µç²¾åŠ›ä¸å˜
            
            // è¿æ¥å˜åŒ–
            if (state.energy > 35) {
                // ç²¾åŠ›æ­£å¸¸æ—¶ï¼Œä»»ä½•æ´»åŠ¨éƒ½å¢åŠ è¿æ¥
                state.bonding = Math.min(100, state.bonding + Math.floor(minutes / 3));
            } else {
                // ç²¾åŠ›ä½æ—¶ï¼Œåªæœ‰ä¼‘æ¯å¢åŠ è¿æ¥
                if (activity === 'rest') {
                    state.bonding = Math.min(100, state.bonding + Math.floor(minutes / 2));
                }
            }
            
            saveState();
        }

        function updateDisplay() {
            energyDisplay.textContent = `${Math.round(state.energy)}%`;
            bondingDisplay.textContent = `${Math.round(state.bonding)}%`;
        }

        function updateCreatureState() {
            creature.className = 'creature';
            
            const energy = state.energy;
            const bonding = state.bonding;
            
            // ç²¾åŠ›ä½äº35æ‰ç®—ç´¯
            const isLowEnergy = energy < 35;
            // è¿æ¥é«˜äº30ç®—æœ‰è¿æ¥
            const hasConnection = bonding > 30;
            
            if (!isLowEnergy && hasConnection) {
                // æ­£å¸¸ç²¾åŠ› + æœ‰è¿æ¥ = å¼€å¿ƒ
                creature.classList.add('happy');
                statusMessage.textContent = getHappyMessage();
            } else if (!isLowEnergy && !hasConnection) {
                // æ­£å¸¸ç²¾åŠ› + ä½è¿æ¥ = å¥½å¥‡ï¼Œæƒ³è®¤è¯†ä½ 
                statusMessage.textContent = getCuriousMessage();
            } else if (isLowEnergy && hasConnection) {
                // ä½ç²¾åŠ› + æœ‰è¿æ¥ = æ‹…å¿ƒä½ 
                creature.classList.add('tired');
                statusMessage.textContent = getWorriedMessage();
            } else {
                // ä½ç²¾åŠ› + ä½è¿æ¥ = éœ€è¦å…³æ³¨
                creature.classList.add('tired');
                statusMessage.textContent = getUpsetMessage();
            }
        }

        function updateCreatureActivity(activity) {
            creature.className = 'creature';
            switch(activity) {
                case 'work': creature.classList.add('working'); break;
                case 'rest': creature.classList.add('resting'); break;
                case 'create': creature.classList.add('creating'); break;
                case 'exercise': creature.classList.add('exercising'); break;
                case 'social': creature.classList.add('socializing'); break;
                case 'read': creature.classList.add('reading'); break;
            }
        }

        function updateBalanceBars() {
            const total = Math.max(1, Object.values(todayLogs).reduce((a, b) => a + b, 0));
            const types = ['work', 'rest', 'create', 'exercise', 'social', 'read'];
            
            types.forEach(type => {
                const bar = document.getElementById(`bar-${type}`);
                const time = document.getElementById(`time-${type}`);
                const minutes = todayLogs[type] || 0;
                const percentage = (minutes / total) * 100;
                
                bar.style.width = `${percentage}%`;
                time.textContent = `${minutes}åˆ†`;
            });
        }

        // ==================== å°åŠ¨ä½œ ====================
        function startIdleActions() {
            // æ¯éš”ä¸€æ®µæ—¶é—´éšæœºåšä¸ªå°åŠ¨ä½œ
            idleActionInterval = setInterval(() => {
                if (isRunning) return; // æ´»åŠ¨ä¸­ä¸åš
                
                const rand = Math.random();
                
                if (rand < 0.25) {
                    // ä¸œå¼ è¥¿æœ› - çœ¼ç›ç§»åŠ¨
                    const eyes = creature.querySelectorAll('.eye');
                    eyes[0].style.transform = 'translateX(-4px)';
                    eyes[1].style.transform = 'translateX(4px)';
                    setTimeout(() => {
                        eyes[0].style.transform = '';
                        eyes[1].style.transform = '';
                    }, 1500);
                } else if (rand < 0.5) {
                    // çœ¨çœ¼
                    const eyes = creature.querySelectorAll('.eye');
                    eyes.forEach(eye => {
                        eye.style.transform = 'scaleY(0.1)';
                    });
                    setTimeout(() => {
                        eyes.forEach(eye => eye.style.transform = '');
                    }, 150);
                    setTimeout(() => {
                        eyes.forEach(eye => eye.style.transform = 'scaleY(0.1)');
                        setTimeout(() => eyes.forEach(eye => eye.style.transform = ''), 150);
                    }, 300);
                } else if (rand < 0.7) {
                    // å‘å…‰ä¸€ä¸‹
                    creature.style.boxShadow = '0 0 100px rgba(168, 216, 234, 0.8)';
                    setTimeout(() => creature.style.boxShadow = '', 800);
                } else if (rand < 0.85) {
                    // è¯´ç‚¹ä»€ä¹ˆ
                    const idleMessages = ['...', 'ï¼ˆçœ‹çœ‹å››å‘¨ï¼‰', 'ï¼ˆå‘å‘†ä¸­ï¼‰', 'å—¯...', 'ï½'];
                    statusMessage.textContent = idleMessages[Math.floor(Math.random() * idleMessages.length)];
                    setTimeout(() => {
                        if (!isRunning) updateCreatureState();
                    }, 2000);
                } else {
                    // å˜å¤§ä¸€ç‚¹ç‚¹
                    creature.style.width = '130px';
                    creature.style.height = '130px';
                    setTimeout(() => {
                        creature.style.width = '';
                        creature.style.height = '';
                    }, 500);
                }
                
            }, 3000 + Math.random() * 2000); // 3-5ç§’éšæœº
        }

        // ==================== æ¶ˆæ¯ ====================
        function getActivityMessage(activity) {
            const messages = {
                work: 'ä¸“æ³¨ä¸­...æˆ‘é™ªç€ä½ ',
                rest: 'å¥½å¥½ä¼‘æ¯ï¼Œè¿™å¾ˆé‡è¦',
                create: 'åˆ›é€ çš„æ—¶åˆ»',
                exercise: 'åŠ¨èµ·æ¥ï½',
                social: 'è¿æ¥æ˜¯çè´µçš„',
                read: 'æ²‰æµ¸åœ¨æ–‡å­—é‡Œ...'
            };
            return messages[activity];
        }

        function getHappyMessage() {
            const messages = ['åœ¨ä¸€èµ·çœŸå¥½', 'ä»Šå¤©å¾ˆå¹³è¡¡', 'æˆ‘æ„Ÿè§‰åˆ°ä½ äº†', 'å°±æ˜¯è¿™æ ·'];
            return messages[Math.floor(Math.random() * messages.length)];
        }

        function getCuriousMessage() {
            const messages = ['ä½ æ¥äº†', 'æƒ³é è¿‘ä½ ', 'ä»Šå¤©æ€ä¹ˆæ ·ï¼Ÿ', 'æˆ‘åœ¨è¿™é‡Œ'];
            return messages[Math.floor(Math.random() * messages.length)];
        }

        function getWorriedMessage() {
            const messages = ['ä½ ç´¯äº†å§ï¼Ÿ', 'è¦ä¸è¦ä¼‘æ¯ä¸€ä¸‹', 'æˆ‘æœ‰ç‚¹æ‹…å¿ƒä½ ', 'æ…¢ä¸€ç‚¹ä¹Ÿå¯ä»¥'];
            return messages[Math.floor(Math.random() * messages.length)];
        }

        function getUpsetMessage() {
            // ä½ç²¾åŠ›+ä½è¿æ¥ï¼Œä½†ä¸è¦å¤ªaggressive
            const messages = ['...åœ¨è¿™é‡Œ', 'ï¼ˆå®‰é™åœ°çœ‹ç€ä½ ï¼‰', 'éœ€è¦ä¼‘æ¯å—', 'æ…¢æ…¢æ¥'];
            return messages[Math.floor(Math.random() * messages.length)];
        }

        function getClickResponse() {
            const energy = state.energy;
            const bonding = state.bonding;
            
            if (bonding > 50) {
                return ['å—¯ï¼', 'åœ¨ï½', 'â™¡', 'çœ‹åˆ°ä½ äº†'][Math.floor(Math.random() * 4)];
            } else if (bonding > 20) {
                return ['å—¯', 'å—¨', '...åœ¨', 'ğŸ‘€'][Math.floor(Math.random() * 4)];
            } else {
                // æ–°æœ‹å‹ï¼Œè¿˜æ˜¯è¦å‹å¥½
                return ['ä½ å¥½', 'å—¨...', 'ï¼ˆçœ¨çœ¨çœ¼ï¼‰', 'å—¯'][Math.floor(Math.random() * 4)];
            }
        }

        // ==================== æé†’ ====================
        function playNotification() {
            // éœ‡åŠ¨
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
            
            // è§†è§‰æç¤º
            creature.classList.add('timer-done');
            statusMessage.textContent = 'æ—¶é—´åˆ°äº†ï½';
            
            // å°è¯•æ’­æ”¾å£°éŸ³
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 440;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.3;
                
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('æ— æ³•æ’­æ”¾å£°éŸ³');
            }
            
            setTimeout(() => {
                creature.classList.remove('timer-done');
            }, 2000);
        }

        // ==================== ä¿å­˜ ====================
        function saveState() {
            state.lastVisit = Date.now();
            localStorage.setItem('queertime-state', JSON.stringify(state));
        }

        // é¡µé¢å…³é—­å‰ä¿å­˜
        window.addEventListener('beforeunload', saveState);
    </script>
</body>
</html>
