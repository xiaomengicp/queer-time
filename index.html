<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¥¿æ¥é£Ÿ å›°æ¥çœ </title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 300;
            margin-bottom: 10px;
            color: #a8d8ea;
            letter-spacing: 2px;
        }

        /* ç”¨æˆ·çŠ¶æ€æ  */
        .user-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            font-size: 0.75rem;
        }

        .user-email {
            color: #666;
        }

        .sync-status {
            color: #55efc4;
        }

        .sync-status.syncing {
            color: #fdcb6e;
        }

        .sync-status.error {
            color: #ff7675;
        }

        .auth-btn {
            padding: 4px 12px;
            background: transparent;
            border: 1px solid rgba(168, 216, 234, 0.3);
            border-radius: 10px;
            color: #a8d8ea;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .auth-btn:hover {
            background: rgba(168, 216, 234, 0.1);
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            font-size: 0.8rem;
        }

        .stat {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stat-label {
            color: #888;
        }

        .stat-value {
            color: #a8d8ea;
        }

        .creature-container {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            cursor: pointer;
        }

        .creature {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 30%, #a8d8ea, #5e9ecf, #3d5a80);
            box-shadow: 
                0 0 60px rgba(168, 216, 234, 0.4),
                inset 0 0 30px rgba(255, 255, 255, 0.1);
            animation: float 4s ease-in-out infinite, breathe 3s ease-in-out infinite;
            position: relative;
            transition: all 0.5s ease;
        }

        /* æ´»åŠ¨çŠ¶æ€é¢œè‰² */
        .creature.working { background: radial-gradient(circle at 30% 30%, #ffd93d, #f39c12, #d68910); box-shadow: 0 0 60px rgba(255, 217, 61, 0.4); }
        .creature.resting { background: radial-gradient(circle at 30% 30%, #a29bfe, #6c5ce7, #5849a6); box-shadow: 0 0 60px rgba(162, 155, 254, 0.4); }
        .creature.creating { background: radial-gradient(circle at 30% 30%, #fd79a8, #e84393, #c23672); box-shadow: 0 0 60px rgba(253, 121, 168, 0.4); }
        .creature.exercising { background: radial-gradient(circle at 30% 30%, #55efc4, #00b894, #00a381); box-shadow: 0 0 60px rgba(85, 239, 196, 0.4); }
        .creature.socializing { background: radial-gradient(circle at 30% 30%, #fdcb6e, #f39c12, #d68910); box-shadow: 0 0 60px rgba(253, 203, 110, 0.4); }
        .creature.reading { background: radial-gradient(circle at 30% 30%, #81ecec, #00cec9, #00a8a3); box-shadow: 0 0 60px rgba(129, 236, 236, 0.4); }

        /* ç²¾åŠ›ä½ */
        .creature.tired {
            background: radial-gradient(circle at 30% 30%, #636e72, #535c68, #3d4145);
            box-shadow: 0 0 30px rgba(99, 110, 114, 0.3);
            animation: float 6s ease-in-out infinite, breathe 5s ease-in-out infinite;
        }

        /* è¿æ¥ä½+ç²¾åŠ›ä½ï¼šçƒ¦èº */
        .creature.upset {
            animation: float 4s ease-in-out infinite, breathe 3s ease-in-out infinite, shake 0.3s ease-in-out infinite;
        }

        /* è¿æ¥é«˜+ç²¾åŠ›é«˜ï¼šå‘å…‰ */
        .creature.happy {
            box-shadow: 0 0 80px rgba(168, 216, 234, 0.6), 0 0 120px rgba(168, 216, 234, 0.3);
        }

        .eyes {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            gap: 20px;
        }

        .eye {
            width: 12px;
            height: 12px;
            background: #1a1a2e;
            border-radius: 50%;
            animation: blink 4s ease-in-out infinite;
            transition: all 0.3s ease;
        }

        .creature.tired .eye {
            height: 6px;
            border-radius: 6px;
        }

        .creature.upset .eye {
            transform: rotate(-10deg);
        }

        /* å°åŠ¨ä½œ */
        .creature.looking-around .eye:first-child {
            transform: translateX(-5px);
        }
        .creature.looking-around .eye:last-child {
            transform: translateX(5px);
        }

        .creature.stretching {
            transform: scaleY(1.15) scaleX(0.9);
        }

        .creature.noticed-you .eye {
            width: 16px !important;
            height: 16px !important;
            transition: all 0.2s ease;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes breathe {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes blink {
            0%, 45%, 55%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            75% { transform: translateX(2px); }
        }

        @keyframes quickBlink {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.1); }
        }

        .status-message {
            font-size: 0.9rem;
            color: #a8d8ea;
            margin-bottom: 15px;
            text-align: center;
            min-height: 24px;
            transition: all 0.3s ease;
        }

        .timer-display {
            font-size: 3rem;
            font-weight: 200;
            margin-bottom: 15px;
            font-variant-numeric: tabular-nums;
            color: #e8e8e8;
        }

        .current-activity {
            font-size: 1rem;
            color: #a8d8ea;
            margin-bottom: 15px;
        }

        .activities {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            width: 100%;
            max-width: 360px;
        }

        .activity-btn {
            padding: 15px 10px;
            border: 1px solid rgba(168, 216, 234, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            color: #e8e8e8;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .activity-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(168, 216, 234, 0.5);
        }

        .activity-btn.active {
            background: rgba(168, 216, 234, 0.2);
            border-color: #a8d8ea;
        }

        .activity-btn.work { border-color: #ffd93d; }
        .activity-btn.work.active { background: rgba(255, 217, 61, 0.2); }
        .activity-btn.rest { border-color: #a29bfe; }
        .activity-btn.rest.active { background: rgba(162, 155, 254, 0.2); }
        .activity-btn.create { border-color: #fd79a8; }
        .activity-btn.create.active { background: rgba(253, 121, 168, 0.2); }
        .activity-btn.exercise { border-color: #55efc4; }
        .activity-btn.exercise.active { background: rgba(85, 239, 196, 0.2); }
        .activity-btn.social { border-color: #fdcb6e; }
        .activity-btn.social.active { background: rgba(253, 203, 110, 0.2); }
        .activity-btn.read { border-color: #81ecec; }
        .activity-btn.read.active { background: rgba(129, 236, 236, 0.2); }

        .timer-settings {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }

        .timer-input {
            width: 60px;
            padding: 8px;
            border: 1px solid rgba(168, 216, 234, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #e8e8e8;
            text-align: center;
            font-size: 1rem;
        }

        .timer-input:focus {
            outline: none;
            border-color: #a8d8ea;
        }

        .timer-label {
            color: #a8d8ea;
            font-size: 0.9rem;
        }

        .control-btn {
            padding: 15px 40px;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .start-btn {
            background: linear-gradient(135deg, #a8d8ea, #5e9ecf);
            color: #1a1a2e;
        }

        .start-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(168, 216, 234, 0.4);
        }

        .stop-btn {
            background: linear-gradient(135deg, #ff7675, #d63031);
            color: #fff;
        }

        .stop-btn:hover {
            transform: scale(1.05);
        }

        .checkin-btn {
            padding: 8px 24px;
            border: 1px solid rgba(168, 216, 234, 0.4);
            border-radius: 20px;
            background: transparent;
            color: #a8d8ea;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkin-btn:hover {
            background: rgba(168, 216, 234, 0.1);
            border-color: #a8d8ea;
        }

        .presence-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            margin-bottom: 5px;
        }

        .stuck-btn {
            padding: 8px 24px;
            border: 1px solid rgba(99, 110, 114, 0.4);
            border-radius: 20px;
            background: transparent;
            color: #636e72;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stuck-btn:hover {
            background: rgba(99, 110, 114, 0.1);
            border-color: #636e72;
            color: #888;
        }

        .balance-container {
            width: 100%;
            max-width: 360px;
            margin-top: 15px;
        }

        .balance-title {
            font-size: 0.85rem;
            color: #a8d8ea;
            margin-bottom: 10px;
        }

        .balance-bars {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .balance-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .balance-label {
            width: 50px;
            font-size: 0.75rem;
            color: #888;
        }

        .balance-bar {
            flex: 1;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .balance-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .balance-fill.work { background: #ffd93d; }
        .balance-fill.rest { background: #a29bfe; }
        .balance-fill.create { background: #fd79a8; }
        .balance-fill.exercise { background: #55efc4; }
        .balance-fill.social { background: #fdcb6e; }
        .balance-fill.read { background: #81ecec; }

        .balance-time {
            width: 50px;
            font-size: 0.75rem;
            color: #888;
            text-align: right;
        }

        .bottom-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .reset-btn {
            padding: 8px 20px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            color: #888;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .reset-btn:hover {
            border-color: rgba(255, 255, 255, 0.4);
            color: #aaa;
        }

        /* å¼¹çª— */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal {
            background: #1a1a2e;
            border: 1px solid rgba(168, 216, 234, 0.3);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 300px;
        }

        .modal-title {
            font-size: 1.1rem;
            color: #a8d8ea;
            margin-bottom: 8px;
        }

        .modal-desc {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 20px;
        }

        .modal-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .modal-row label {
            color: #888;
            font-size: 0.9rem;
            width: 50px;
        }

        .modal-row select,
        .modal-row input {
            flex: 1;
            padding: 8px;
            border: 1px solid rgba(168, 216, 234, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #e8e8e8;
            font-size: 0.9rem;
        }

        .modal-row select:focus,
        .modal-row input:focus {
            outline: none;
            border-color: #a8d8ea;
        }

        .modal-row span {
            color: #888;
            font-size: 0.9rem;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
        }

        .modal-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #888;
        }

        .modal-btn.confirm {
            background: linear-gradient(135deg, #a8d8ea, #5e9ecf);
            color: #1a1a2e;
        }

        /* ç™»å½•è¡¨å• */
        .auth-input {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(168, 216, 234, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #e8e8e8;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }

        .auth-input:focus {
            outline: none;
            border-color: #a8d8ea;
        }

        .auth-message {
            font-size: 0.8rem;
            color: #55efc4;
            margin-bottom: 10px;
            text-align: center;
        }

        .auth-message.error {
            color: #ff7675;
        }

        /* æé†’éŸ³æ•ˆæç¤º */
        .timer-done {
            animation: pulse 0.5s ease-in-out 3;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* æ—¶é—´çš„è´¨åœ° - é¢œè‰²é€‰æ‹©å™¨ */
        .texture-picker {
            display: none;
            justify-content: center;
            gap: 12px;
            margin-top: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .texture-picker.show {
            display: flex;
            opacity: 1;
        }

        .texture-picker.fade-out {
            opacity: 0;
        }

        .texture-color {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 2px solid transparent;
        }

        .texture-color:hover {
            transform: scale(1.2);
        }

        .texture-color:active {
            transform: scale(0.95);
        }

        .texture-color.red { background: #e74c3c; }
        .texture-color.orange { background: #e67e22; }
        .texture-color.yellow { background: #f1c40f; }
        .texture-color.green { background: #2ecc71; }
        .texture-color.cyan { background: #1abc9c; }
        .texture-color.blue { background: #3498db; }
        .texture-color.purple { background: #9b59b6; }

        .texture-color.selected {
            box-shadow: 0 0 20px currentColor;
            transform: scale(1.1);
        }

        /* å°çƒå¸æ”¶é¢œè‰²çš„åŠ¨ç”» */
        @keyframes absorb-color {
            0% { box-shadow: 0 0 60px var(--absorb-color); }
            50% { box-shadow: 0 0 100px var(--absorb-color); }
            100% { box-shadow: 0 0 60px rgba(168, 216, 234, 0.4); }
        }

        .creature.absorbing {
            animation: absorb-color 0.8s ease-out;
        }
    </style>
</head>
<body>
    <h1 id="app-title">é¥¿æ¥é£Ÿ å›°æ¥çœ </h1>
    
    <!-- ç”¨æˆ·çŠ¶æ€æ  -->
    <div class="user-bar">
        <span class="user-email" id="user-email">æœªç™»å½•</span>
        <span class="sync-status" id="sync-status"></span>
        <button class="auth-btn" id="auth-btn">ç™»å½•</button>
        <button class="auth-btn" id="lang-btn">EN</button>
    </div>
    
    <div class="stats-bar">
        <div class="stat">
            <span class="stat-label" id="energy-label">ç²¾åŠ›</span>
            <span class="stat-value" id="energy-display">50%</span>
        </div>
        <div class="stat">
            <span class="stat-label" id="bonding-label">è¿æ¥</span>
            <span class="stat-value" id="bonding-display">0%</span>
        </div>
    </div>
    
    <div class="creature-container" id="creature-container">
        <div class="creature" id="creature">
            <div class="eyes">
                <div class="eye"></div>
                <div class="eye"></div>
            </div>
        </div>
    </div>
    
    <div class="status-message" id="status-message">ä½ æ¥äº†</div>
    
    <!-- æ—¶é—´çš„è´¨åœ° - é¢œè‰²é€‰æ‹©å™¨ -->
    <div class="texture-picker" id="texture-picker">
        <div class="texture-color red" data-color="red"></div>
        <div class="texture-color orange" data-color="orange"></div>
        <div class="texture-color yellow" data-color="yellow"></div>
        <div class="texture-color green" data-color="green"></div>
        <div class="texture-color cyan" data-color="cyan"></div>
        <div class="texture-color blue" data-color="blue"></div>
        <div class="texture-color purple" data-color="purple"></div>
    </div>
    
    <div class="timer-display" id="timer-display">00:00</div>
    
    <div class="current-activity" id="current-activity"></div>
    
    <div class="activities" id="activities">
        <button class="activity-btn work" data-type="work">å·¥ä½œ</button>
        <button class="activity-btn rest" data-type="rest">ä¼‘æ¯</button>
        <button class="activity-btn create" data-type="create">åˆ›é€ </button>
        <button class="activity-btn exercise" data-type="exercise">è¿åŠ¨</button>
        <button class="activity-btn social" data-type="social">ç¤¾äº¤</button>
        <button class="activity-btn read" data-type="read">é˜…è¯»</button>
    </div>
    
    <div class="timer-settings" id="timer-settings">
        <span class="timer-label" id="timer-label-1">è®¾å®šæ—¶é—´ï¼š</span>
        <input type="number" class="timer-input" id="timer-input" placeholder="åˆ†é’Ÿ" min="1" max="180">
        <span class="timer-label" id="timer-label-2">åˆ†é’Ÿ</span>
    </div>
    
    <div>
        <button class="control-btn start-btn" id="start-btn">å¼€å§‹</button>
        <button class="control-btn stop-btn" id="stop-btn" style="display: none;">ç»“æŸ</button>
    </div>
    
    <div class="presence-buttons">
        <button class="checkin-btn" id="checkin-btn">å…±åœ¨</button>
        <button class="stuck-btn" id="stuck-btn">ä»€ä¹ˆéƒ½åšä¸äº†</button>
    </div>
    
    <div class="balance-container">
        <div class="balance-title" id="balance-title">ä»Šæ—¥å¹³è¡¡</div>
        <div class="balance-bars" id="balance-bars">
            <div class="balance-row">
                <span class="balance-label" id="label-work">å·¥ä½œ</span>
                <div class="balance-bar"><div class="balance-fill work" id="bar-work"></div></div>
                <span class="balance-time" id="time-work">0åˆ†</span>
            </div>
            <div class="balance-row">
                <span class="balance-label" id="label-rest">ä¼‘æ¯</span>
                <div class="balance-bar"><div class="balance-fill rest" id="bar-rest"></div></div>
                <span class="balance-time" id="time-rest">0åˆ†</span>
            </div>
            <div class="balance-row">
                <span class="balance-label" id="label-create">åˆ›é€ </span>
                <div class="balance-bar"><div class="balance-fill create" id="bar-create"></div></div>
                <span class="balance-time" id="time-create">0åˆ†</span>
            </div>
            <div class="balance-row">
                <span class="balance-label" id="label-exercise">è¿åŠ¨</span>
                <div class="balance-bar"><div class="balance-fill exercise" id="bar-exercise"></div></div>
                <span class="balance-time" id="time-exercise">0åˆ†</span>
            </div>
            <div class="balance-row">
                <span class="balance-label" id="label-social">ç¤¾äº¤</span>
                <div class="balance-bar"><div class="balance-fill social" id="bar-social"></div></div>
                <span class="balance-time" id="time-social">0åˆ†</span>
            </div>
            <div class="balance-row">
                <span class="balance-label" id="label-read">é˜…è¯»</span>
                <div class="balance-bar"><div class="balance-fill read" id="bar-read"></div></div>
                <span class="balance-time" id="time-read">0åˆ†</span>
            </div>
        </div>
    </div>
    
    <div class="bottom-buttons">
        <button class="reset-btn" id="log-btn">è¡¥è®°</button>
        <button class="reset-btn" id="about-btn">å…³äº</button>
        <button class="reset-btn" id="reset-btn">é‡ç½®ä»Šæ—¥</button>
        <button class="reset-btn" id="export-btn">å¯¼å‡º</button>
    </div>
    
    <!-- è¡¥è®°å¼¹çª— -->
    <div class="modal-overlay" id="log-modal" style="display: none;">
        <div class="modal">
            <div class="modal-title" id="log-modal-title">è¡¥è®°ä¸€æ®µæ—¶é—´</div>
            <div class="modal-desc" id="log-modal-desc">åªè®°å½•æ•°æ®ï¼Œä¸å¢åŠ è¿æ¥å€¼</div>
            <div class="modal-row">
                <label id="log-label-activity">æ´»åŠ¨ï¼š</label>
                <select id="log-activity">
                    <option value="work">å·¥ä½œ</option>
                    <option value="rest">ä¼‘æ¯</option>
                    <option value="create">åˆ›é€ </option>
                    <option value="exercise">è¿åŠ¨</option>
                    <option value="social">ç¤¾äº¤</option>
                    <option value="read">é˜…è¯»</option>
                </select>
            </div>
            <div class="modal-row">
                <label id="log-label-duration">æ—¶é•¿ï¼š</label>
                <input type="number" id="log-minutes" placeholder="åˆ†é’Ÿ" min="1" max="480">
                <span id="log-label-minutes">åˆ†é’Ÿ</span>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="log-cancel">å–æ¶ˆ</button>
                <button class="modal-btn confirm" id="log-confirm">è®°å½•</button>
            </div>
        </div>
    </div>

    <!-- ç™»å½•å¼¹çª— -->
    <div class="modal-overlay" id="auth-modal" style="display: none;">
        <div class="modal">
            <div class="modal-title" id="auth-modal-title">ç™»å½•</div>
            <div class="modal-desc" id="auth-modal-desc">ç™»å½•åæ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯</div>
            <div class="auth-message" id="auth-message"></div>
            <input type="email" class="auth-input" id="auth-email" placeholder="é‚®ç®±">
            <input type="password" class="auth-input" id="auth-password" placeholder="å¯†ç ">
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="auth-cancel">å–æ¶ˆ</button>
                <button class="modal-btn confirm" id="auth-confirm">ç™»å½•</button>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <span style="color: #666; font-size: 0.8rem;" id="auth-no-account">æ²¡æœ‰è´¦å·ï¼Ÿ</span>
                <button style="background: none; border: none; color: #a8d8ea; font-size: 0.8rem; cursor: pointer;" id="auth-toggle">æ³¨å†Œ</button>
            </div>
        </div>
    </div>

    <!-- å…³äºå¼¹çª— -->
    <div class="modal-overlay" id="about-modal" style="display: none;">
        <div class="modal" style="max-width: 340px;">
            <div class="modal-title" id="about-title">é¥¿æ¥é£Ÿï¼Œå›°æ¥çœ </div>
            <div style="color: #888; font-size: 0.85rem; line-height: 1.6;" id="about-content">
                <p style="margin-bottom: 12px;" id="about-p1">ä¸æ˜¯æ—¶é—´ç®¡ç†å·¥å…·ã€‚ä¸æ˜¯å¾…åŠæ¸…å•ã€‚</p>
                <p style="margin-bottom: 12px;" id="about-p2">æ˜¯ä¸€ä¸ªå°å°çš„å­˜åœ¨ï¼Œé™ªç€ä½ ã€‚</p>
                <p style="margin-bottom: 12px;" id="about-p3">å®ƒæ˜¯ä½ å†…åœ¨å°å­©çš„å¤–åœ¨åŒ–ã€‚ç…§é¡¾å®ƒï¼Œå…¶å®æ˜¯ç…§é¡¾è‡ªå·±ã€‚</p>
                <p style="margin-bottom: 16px; color: #666; font-size: 0.8rem;" id="about-p4">å…­ç§æ´»åŠ¨ï¼Œå…­ç§æ»‹å…»ï¼š<br>å·¥ä½œ(ç»æµ)ã€ä¼‘æ¯(èº«ä½“)ã€åˆ›é€ (ç²¾ç¥)<br>è¿åŠ¨(ç²¾åŠ›)ã€ç¤¾äº¤(å…³ç³»)ã€é˜…è¯»(æ™ºè¯†)</p>
                <p style="color: #a8d8ea; font-style: italic;" id="about-quote">é¥¿äº†å°±åƒï¼Œå›°äº†å°±ç¡ã€‚</p>
                <p style="margin-top: 16px; color: #555; font-size: 0.75rem;" id="about-source">â€”â€” å‡ºè‡ªç¦…å®—ã€Šæ™¯å¾·ä¼ ç¯å½•ã€‹</p>
            </div>
            <div style="margin-top: 16px; text-align: center;">
                <a href="https://ko-fi.com/joqiao" target="_blank" style="color: #a8d8ea; font-size: 0.8rem; text-decoration: none;" id="kofi-link">â˜• è¯·æˆ‘å–æ¯å’–å•¡</a>
            </div>
            <div class="modal-buttons" style="margin-top: 16px;">
                <button class="modal-btn confirm" id="about-close" style="flex: 1;">å¥½</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== å¤šè¯­è¨€ ====================
        let currentLang = localStorage.getItem('queertime-lang') || 'zh';
        
        const i18n = {
            zh: {
                title: 'é¥¿æ¥é£Ÿ å›°æ¥çœ ',
                notLoggedIn: 'æœªç™»å½•',
                login: 'ç™»å½•',
                logout: 'é€€å‡º',
                energy: 'ç²¾åŠ›',
                bonding: 'è¿æ¥',
                greeting: 'ä½ æ¥äº†',
                work: 'å·¥ä½œ',
                rest: 'ä¼‘æ¯',
                create: 'åˆ›é€ ',
                exercise: 'è¿åŠ¨',
                social: 'ç¤¾äº¤',
                read: 'é˜…è¯»',
                setTime: 'è®¾å®šæ—¶é—´ï¼š',
                minutes: 'åˆ†é’Ÿ',
                start: 'å¼€å§‹',
                end: 'ç»“æŸ',
                bePresent: 'å…±åœ¨',
                todayBalance: 'ä»Šæ—¥å¹³è¡¡',
                log: 'è¡¥è®°',
                about: 'å…³äº',
                resetToday: 'é‡ç½®',
                export: 'å¯¼å‡º',
                synced: 'å·²åŒæ­¥',
                syncing: 'åŒæ­¥ä¸­...',
                selectActivity: 'é€‰æ‹©ä¸€ä¸ªæ´»åŠ¨å§',
                welcomeBack: 'æ¬¢è¿å›æ¥ï¼Œç»§ç»­',
                ongoing: 'ä¸­',
                texturePrompt: 'è¿™æ®µæ—¶é—´çš„æ„Ÿè§‰ï¼Ÿ',
                checkinPrompt: 'æ­¤åˆ»çš„æ„Ÿè§‰ï¼Ÿ',
                noted: 'è®°ä¸‹äº†',
                present: 'å…±åœ¨',
                stuck: 'ä»€ä¹ˆéƒ½åšä¸äº†',
                stuckMsgs: ['æˆ‘åœ¨', 'æ²¡å…³ç³»', 'å°±å¾…ç€', 'é™ªç€ä½ ', 'ä¸ç”¨åšä»€ä¹ˆ'],
                logged: 'å·²è¡¥è®°',
                finishFirst: 'å…ˆç»“æŸå½“å‰æ´»åŠ¨',
                confirmReset: 'ç¡®å®šè¦é‡ç½®ä»Šæ—¥è®°å½•å—ï¼Ÿ',
                enterValidTime: 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ—¶é•¿',
                timeUp: 'æ—¶é—´åˆ°äº†ï½',
                // æ´»åŠ¨æ¶ˆæ¯
                msgWork: 'ä¸“æ³¨ä¸­...æˆ‘é™ªç€ä½ ',
                msgRest: 'å¥½å¥½ä¼‘æ¯ï¼Œè¿™å¾ˆé‡è¦',
                msgCreate: 'åˆ›é€ çš„æ—¶åˆ»',
                msgExercise: 'åŠ¨èµ·æ¥ï½',
                msgSocial: 'è¿æ¥æ˜¯çè´µçš„',
                msgRead: 'æ²‰æµ¸åœ¨æ–‡å­—é‡Œ...',
                // çŠ¶æ€æ¶ˆæ¯
                happyMsgs: ['åœ¨ä¸€èµ·çœŸå¥½', 'ä»Šå¤©å¾ˆå¹³è¡¡', 'æˆ‘æ„Ÿè§‰åˆ°ä½ äº†', 'å°±æ˜¯è¿™æ ·'],
                curiousMsgs: ['ä½ æ¥äº†', 'æƒ³é è¿‘ä½ ', 'ä»Šå¤©æ€ä¹ˆæ ·ï¼Ÿ', 'æˆ‘åœ¨è¿™é‡Œ'],
                worriedMsgs: ['ä½ ç´¯äº†å§ï¼Ÿ', 'è¦ä¸è¦ä¼‘æ¯ä¸€ä¸‹', 'æˆ‘æœ‰ç‚¹æ‹…å¿ƒä½ ', 'æ…¢ä¸€ç‚¹ä¹Ÿå¯ä»¥'],
                upsetMsgs: ['...åœ¨è¿™é‡Œ', 'ï¼ˆå®‰é™åœ°çœ‹ç€ä½ ï¼‰', 'éœ€è¦ä¼‘æ¯å—', 'æ…¢æ…¢æ¥'],
                idleMsgs: ['...', 'ï¼ˆçœ‹çœ‹å››å‘¨ï¼‰', 'ï¼ˆå‘å‘†ä¸­ï¼‰', 'å—¯...', 'ï½'],
                clickHighBond: ['å—¯ï¼', 'åœ¨ï½', 'â™¡', 'çœ‹åˆ°ä½ äº†'],
                clickMidBond: ['å—¯', 'å—¨', '...åœ¨', 'ğŸ‘€'],
                clickLowBond: ['ä½ å¥½', 'å—¨...', 'ï¼ˆçœ¨çœ¨çœ¼ï¼‰', 'å—¯'],
                // å¼¹çª—
                logTitle: 'è¡¥è®°ä¸€æ®µæ—¶é—´',
                logDesc: 'åªè®°å½•æ•°æ®ï¼Œä¸å¢åŠ è¿æ¥å€¼',
                activity: 'æ´»åŠ¨ï¼š',
                duration: 'æ—¶é•¿ï¼š',
                cancel: 'å–æ¶ˆ',
                confirm: 'è®°å½•',
                authTitle: 'ç™»å½•',
                authDesc: 'ç™»å½•åæ•°æ®ä¼šè‡ªåŠ¨åŒæ­¥åˆ°äº‘ç«¯',
                email: 'é‚®ç®±',
                password: 'å¯†ç ',
                noAccount: 'æ²¡æœ‰è´¦å·ï¼Ÿ',
                register: 'æ³¨å†Œ',
                processing: 'å¤„ç†ä¸­...',
                registerSuccess: 'æ³¨å†ŒæˆåŠŸï¼è¯·æŸ¥æ”¶éªŒè¯é‚®ä»¶',
                enterEmailPassword: 'è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ',
                // å…³äº
                aboutTitle: 'é¥¿æ¥é£Ÿï¼Œå›°æ¥çœ ',
                aboutP1: 'ä¸æ˜¯æ—¶é—´ç®¡ç†å·¥å…·ã€‚ä¸æ˜¯å¾…åŠæ¸…å•ã€‚',
                aboutP2: 'æ˜¯ä¸€ä¸ªå°å°çš„å­˜åœ¨ï¼Œé™ªç€ä½ ã€‚',
                aboutP3: 'å®ƒæ˜¯ä½ å†…åœ¨å°å­©çš„å¤–åœ¨åŒ–ã€‚ç…§é¡¾å®ƒï¼Œå…¶å®æ˜¯ç…§é¡¾è‡ªå·±ã€‚',
                aboutP4: 'å…­ç§æ´»åŠ¨ï¼Œå…­ç§æ»‹å…»ï¼š<br>å·¥ä½œ(ç»æµ)ã€ä¼‘æ¯(èº«ä½“)ã€åˆ›é€ (ç²¾ç¥)<br>è¿åŠ¨(ç²¾åŠ›)ã€ç¤¾äº¤(å…³ç³»)ã€é˜…è¯»(æ™ºè¯†)',
                aboutQuote: 'é¥¿äº†å°±åƒï¼Œå›°äº†å°±ç¡ã€‚',
                aboutSource: 'â€”â€” å‡ºè‡ªç¦…å®—ã€Šæ™¯å¾·ä¼ ç¯å½•ã€‹',
                kofiText: 'â˜• è¯·æˆ‘å–æ¯å’–å•¡',
                ok: 'å¥½'
            },
            en: {
                title: 'Eat when hungry, Sleep when tired',
                notLoggedIn: 'Not logged in',
                login: 'Login',
                logout: 'Logout',
                energy: 'Energy',
                bonding: 'Bonding',
                greeting: 'You\'re here',
                work: 'Work',
                rest: 'Rest',
                create: 'Create',
                exercise: 'Exercise',
                social: 'Social',
                read: 'Read',
                setTime: 'Set time:',
                minutes: 'min',
                start: 'Start',
                end: 'End',
                bePresent: 'Be Present',
                todayBalance: 'Today\'s Balance',
                log: 'Log',
                about: 'About',
                resetToday: 'Reset',
                export: 'Export',
                synced: 'Synced',
                syncing: 'Syncing...',
                selectActivity: 'Pick an activity',
                welcomeBack: 'Welcome back, continuing ',
                ongoing: '',
                texturePrompt: 'How did that feel?',
                checkinPrompt: 'How do you feel now?',
                noted: 'Noted',
                present: 'Present',
                stuck: 'Can\'t do anything',
                stuckMsgs: ['I\'m here', 'It\'s okay', 'Just be', 'With you', 'No need to do anything'],
                logged: 'Logged',
                finishFirst: 'Finish current activity first',
                confirmReset: 'Reset today\'s record?',
                enterValidTime: 'Please enter a valid duration',
                timeUp: 'Time\'s up~',
                // æ´»åŠ¨æ¶ˆæ¯
                msgWork: 'Focusing... I\'m with you',
                msgRest: 'Rest well, it matters',
                msgCreate: 'A moment to create',
                msgExercise: 'Let\'s move~',
                msgSocial: 'Connection is precious',
                msgRead: 'Lost in words...',
                // çŠ¶æ€æ¶ˆæ¯
                happyMsgs: ['Good to be together', 'Balanced today', 'I feel you', 'Just like this'],
                curiousMsgs: ['You\'re here', 'Want to be close', 'How are you?', 'I\'m here'],
                worriedMsgs: ['Tired?', 'Maybe rest a bit?', 'A bit worried', 'Slower is okay'],
                upsetMsgs: ['...here', '(quietly watching)', 'Need rest?', 'Take your time'],
                idleMsgs: ['...', '(looking around)', '(spacing out)', 'hmm...', '~'],
                clickHighBond: ['Mm!', 'Here~', 'â™¡', 'See you'],
                clickMidBond: ['Mm', 'Hi', '...here', 'ğŸ‘€'],
                clickLowBond: ['Hello', 'Hi...', '(blink)', 'Mm'],
                // å¼¹çª—
                logTitle: 'Log past time',
                logDesc: 'Records data only, no bonding added',
                activity: 'Activity:',
                duration: 'Duration:',
                cancel: 'Cancel',
                confirm: 'Log',
                authTitle: 'Login',
                authDesc: 'Login to sync data across devices',
                email: 'Email',
                password: 'Password',
                noAccount: 'No account?',
                register: 'Register',
                processing: 'Processing...',
                registerSuccess: 'Registered! Check your email',
                enterEmailPassword: 'Please enter email and password',
                // å…³äº
                aboutTitle: 'Eat when hungry, Sleep when tired',
                aboutP1: 'Not a time management tool. Not a to-do list.',
                aboutP2: 'Just a little presence, with you.',
                aboutP3: 'It\'s your inner child, externalized. Take care of it, take care of yourself.',
                aboutP4: 'Six activities, six nourishments:<br>Work (wealth), Rest (body), Create (spirit)<br>Exercise (energy), Social (connection), Read (mind)',
                aboutQuote: 'Eat when hungry, sleep when tired.',
                aboutSource: 'â€”â€” From Zen Buddhism "Jingde Record of the Transmission of the Lamp"',
                kofiText: 'â˜• Buy me a coffee',
                ok: 'OK'
            }
        };

        function t(key) {
            return i18n[currentLang][key] || key;
        }

        function setLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('queertime-lang', lang);
            
            // æ›´æ–°ç•Œé¢
            document.getElementById('app-title').textContent = t('title');
            document.getElementById('energy-label').textContent = t('energy');
            document.getElementById('bonding-label').textContent = t('bonding');
            
            // æ´»åŠ¨æŒ‰é’®
            document.querySelector('[data-type="work"]').textContent = t('work');
            document.querySelector('[data-type="rest"]').textContent = t('rest');
            document.querySelector('[data-type="create"]').textContent = t('create');
            document.querySelector('[data-type="exercise"]').textContent = t('exercise');
            document.querySelector('[data-type="social"]').textContent = t('social');
            document.querySelector('[data-type="read"]').textContent = t('read');
            
            // å…¶ä»–æŒ‰é’®
            document.getElementById('timer-label-1').textContent = t('setTime');
            document.getElementById('timer-label-2').textContent = t('minutes');
            document.getElementById('timer-input').placeholder = t('minutes');
            document.getElementById('start-btn').textContent = t('start');
            document.getElementById('stop-btn').textContent = t('end');
            document.getElementById('checkin-btn').textContent = t('bePresent');
            document.getElementById('stuck-btn').textContent = t('stuck');
            document.getElementById('balance-title').textContent = t('todayBalance');
            document.getElementById('log-btn').textContent = t('log');
            document.getElementById('about-btn').textContent = t('about');
            document.getElementById('reset-btn').textContent = t('resetToday');
            document.getElementById('export-btn').textContent = t('export');
            
            // å¹³è¡¡æ¡æ ‡ç­¾
            document.getElementById('label-work').textContent = t('work');
            document.getElementById('label-rest').textContent = t('rest');
            document.getElementById('label-create').textContent = t('create');
            document.getElementById('label-exercise').textContent = t('exercise');
            document.getElementById('label-social').textContent = t('social');
            document.getElementById('label-read').textContent = t('read');
            
            // è¡¥è®°å¼¹çª—
            document.getElementById('log-modal-title').textContent = t('logTitle');
            document.getElementById('log-modal-desc').textContent = t('logDesc');
            document.getElementById('log-label-activity').textContent = t('activity');
            document.getElementById('log-label-duration').textContent = t('duration');
            document.getElementById('log-label-minutes').textContent = t('minutes');
            document.getElementById('log-cancel').textContent = t('cancel');
            document.getElementById('log-confirm').textContent = t('confirm');
            
            // è¡¥è®°å¼¹çª—çš„æ´»åŠ¨é€‰é¡¹
            const logSelect = document.getElementById('log-activity');
            logSelect.options[0].textContent = t('work');
            logSelect.options[1].textContent = t('rest');
            logSelect.options[2].textContent = t('create');
            logSelect.options[3].textContent = t('exercise');
            logSelect.options[4].textContent = t('social');
            logSelect.options[5].textContent = t('read');
            document.getElementById('log-minutes').placeholder = t('minutes');
            
            // ç™»å½•å¼¹çª—
            document.getElementById('auth-modal-title').textContent = t('authTitle');
            document.getElementById('auth-modal-desc').textContent = t('authDesc');
            document.getElementById('auth-email').placeholder = t('email');
            document.getElementById('auth-password').placeholder = t('password');
            document.getElementById('auth-no-account').textContent = t('noAccount');
            document.getElementById('auth-cancel').textContent = t('cancel');
            document.getElementById('auth-confirm').textContent = t('login');
            document.getElementById('auth-toggle').textContent = t('register');
            
            // å…³äºå¼¹çª—
            document.getElementById('about-title').textContent = t('aboutTitle');
            document.getElementById('about-p1').textContent = t('aboutP1');
            document.getElementById('about-p2').textContent = t('aboutP2');
            document.getElementById('about-p3').textContent = t('aboutP3');
            document.getElementById('about-p4').innerHTML = t('aboutP4');
            document.getElementById('about-quote').textContent = t('aboutQuote');
            document.getElementById('about-source').textContent = t('aboutSource');
            document.getElementById('kofi-link').textContent = t('kofiText');
            document.getElementById('about-close').textContent = t('ok');
            
            // è¯­è¨€æŒ‰é’®
            document.getElementById('lang-btn').textContent = lang === 'zh' ? 'EN' : 'ä¸­';
            
            // æ›´æ–°è®¤è¯ UI
            updateAuthUI();
            
            // æ›´æ–°çŠ¶æ€æ¶ˆæ¯
            if (!isRunning) {
                updateCreatureState();
            }
        }

        // ==================== Supabase é…ç½® ====================
        const SUPABASE_URL = 'https://kkocffqigydkupprgayh.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtrb2NmZnFpZ3lka3VwcHJnYXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc1MjMyOTksImV4cCI6MjA4MzA5OTI5OX0.pnmK_OP3FplrgU4L2XJFEg9ek0M3n0VwTjliiRscG4U';
        
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: {
                persistSession: true,
                storageKey: 'queertime-auth',
                storage: window.localStorage
            }
        });
        
        let currentUser = null;
        let isSyncing = false;

        // ==================== çŠ¶æ€ ====================
        let selectedActivity = null;
        let isRunning = false;
        let startTime = null;
        let timerInterval = null;
        let targetMinutes = null;
        let idleActionInterval = null;

        // ==================== æ•°æ®å­˜å‚¨ ====================
        const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD æ ¼å¼
        
        // è¯»å–æ‰€æœ‰å†å²æ•°æ®
        let allData = JSON.parse(localStorage.getItem('queertime-all') || '{}');
        
        // ä»Šæ—¥æ•°æ®
        if (!allData[today]) {
            allData[today] = { work: 0, rest: 0, create: 0, exercise: 0, social: 0, read: 0 };
        }
        let todayLogs = allData[today];

        // ç²¾åŠ›å’Œè¿æ¥å€¼
        let state = JSON.parse(localStorage.getItem('queertime-state') || '{}');
        if (state.energy === undefined) state.energy = 50;
        if (state.bonding === undefined) state.bonding = 0;
        if (!state.lastVisit) state.lastVisit = Date.now();

        // ==================== DOM ====================
        const creature = document.getElementById('creature');
        const creatureContainer = document.getElementById('creature-container');
        const statusMessage = document.getElementById('status-message');
        const timerDisplay = document.getElementById('timer-display');
        const currentActivity = document.getElementById('current-activity');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const timerInput = document.getElementById('timer-input');
        const timerSettings = document.getElementById('timer-settings');
        const resetBtn = document.getElementById('reset-btn');
        const exportBtn = document.getElementById('export-btn');
        const energyDisplay = document.getElementById('energy-display');
        const bondingDisplay = document.getElementById('bonding-display');
        const userEmail = document.getElementById('user-email');
        const syncStatus = document.getElementById('sync-status');
        const authBtn = document.getElementById('auth-btn');

        // ==================== è®¤è¯ç›¸å…³ ====================
        const authModal = document.getElementById('auth-modal');
        const authModalTitle = document.getElementById('auth-modal-title');
        const authMessage = document.getElementById('auth-message');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authCancel = document.getElementById('auth-cancel');
        const authConfirm = document.getElementById('auth-confirm');
        const authToggle = document.getElementById('auth-toggle');

        let isSignUp = false;

        authBtn.addEventListener('click', () => {
            if (currentUser) {
                // å·²ç™»å½•ï¼Œé€€å‡º
                signOut();
            } else {
                // æœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•å¼¹çª—
                authModal.style.display = 'flex';
            }
        });

        authCancel.addEventListener('click', () => {
            authModal.style.display = 'none';
            authMessage.textContent = '';
            authEmailInput.value = '';
            authPasswordInput.value = '';
        });

        authToggle.addEventListener('click', () => {
            isSignUp = !isSignUp;
            authModalTitle.textContent = isSignUp ? t('register') : t('login');
            authConfirm.textContent = isSignUp ? t('register') : t('login');
            authToggle.textContent = isSignUp ? t('login') : t('register');
        });

        authConfirm.addEventListener('click', async () => {
            const email = authEmailInput.value.trim();
            const password = authPasswordInput.value;

            if (!email || !password) {
                authMessage.textContent = t('enterEmailPassword');
                authMessage.classList.add('error');
                return;
            }

            authMessage.textContent = t('processing');
            authMessage.classList.remove('error');

            try {
                if (isSignUp) {
                    const { data, error } = await supabaseClient.auth.signUp({ email, password });
                    if (error) throw error;
                    authMessage.textContent = t('registerSuccess');
                    authMessage.classList.remove('error');
                } else {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                    if (error) throw error;
                    authModal.style.display = 'none';
                    authEmailInput.value = '';
                    authPasswordInput.value = '';
                }
            } catch (error) {
                authMessage.textContent = error.message;
                authMessage.classList.add('error');
            }
        });

        // ç‚¹å‡»é®ç½©å…³é—­
        authModal.addEventListener('click', (e) => {
            if (e.target === authModal) {
                authModal.style.display = 'none';
                authMessage.textContent = '';
            }
        });

        async function signOut() {
            await supabaseClient.auth.signOut();
            currentUser = null;
            updateAuthUI();
        }

        function updateAuthUI() {
            if (currentUser) {
                userEmail.textContent = currentUser.email;
                authBtn.textContent = t('logout');
            } else {
                userEmail.textContent = t('notLoggedIn');
                authBtn.textContent = t('login');
                syncStatus.textContent = '';
            }
        }

        // ==================== äº‘åŒæ­¥ ====================
        async function syncToCloud() {
            if (!currentUser || isSyncing) return;
            
            isSyncing = true;
            syncStatus.textContent = 'åŒæ­¥ä¸­...';
            syncStatus.className = 'sync-status syncing';
            
            const now = Date.now();
            
            
            

            try {
                // åŒæ­¥ç”¨æˆ·çŠ¶æ€
                const { error: stateError } = await supabaseClient
                    .from('user_state')
                    .upsert({
                        user_id: currentUser.id,
                        energy: Math.round(state.energy),
                        bonding: Math.round(state.bonding),
                        last_visit: new Date(state.lastVisit || now).toISOString(),
                        last_interaction: new Date(state.lastInteraction || now).toISOString(),
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'user_id' });

                if (stateError) throw stateError;

                // åŒæ­¥ä»Šæ—¥è®°å½•
                const { error: logsError } = await supabaseClient
                    .from('daily_logs')
                    .upsert({
                        user_id: currentUser.id,
                        log_date: today,
                        work: todayLogs.work,
                        rest: todayLogs.rest,
                        create_time: todayLogs.create,
                        exercise: todayLogs.exercise,
                        social: todayLogs.social,
                        read: todayLogs.read,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'user_id,log_date' });

                if (logsError) throw logsError;
                
                // ä¿å­˜æœ¬åœ°æ›´æ–°æ—¶é—´æˆ³
                localStorage.setItem('queertime-logs-updated', now.toString());
                localStorage.setItem('queertime-state-updated', now.toString());

                
                syncStatus.textContent = t('synced');
                syncStatus.className = 'sync-status';
            } catch (error) {
                console.error('[åŒæ­¥] ä¸Šä¼ å¤±è´¥:', error);
                syncStatus.textContent = 'åŒæ­¥å¤±è´¥';
                syncStatus.className = 'sync-status error';
            } finally {
                isSyncing = false;
            }
        }

        async function syncFromCloud() {
            if (!currentUser) return;

            syncStatus.textContent = 'åŠ è½½ä¸­...';
            syncStatus.className = 'sync-status syncing';
            
            
            
            

            try {
                // è¯»å–ç”¨æˆ·çŠ¶æ€
                const { data: stateData, error: stateError } = await supabaseClient
                    .from('user_state')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (stateData) {
                    
                    
                    // æ¯”è¾ƒæ—¶é—´æˆ³ï¼Œåªç”¨æ›´æ–°çš„æ•°æ®
                    const cloudUpdatedAt = new Date(stateData.updated_at).getTime();
                    const localUpdatedAt = parseInt(localStorage.getItem('queertime-state-updated') || '0');
                    
                    
                    
                    if (cloudUpdatedAt > localUpdatedAt) {
                        
                        state.energy = stateData.energy;
                        state.bonding = stateData.bonding;
                        state.lastVisit = new Date(stateData.last_visit).getTime();
                        if (stateData.last_interaction) {
                            state.lastInteraction = new Date(stateData.last_interaction).getTime();
                        }
                        saveStateLocal();
                        // æ›´æ–°æœ¬åœ°æ—¶é—´æˆ³
                        localStorage.setItem('queertime-state-updated', cloudUpdatedAt.toString());
                        updateDisplay(); // ç«‹å³æ›´æ–°æ˜¾ç¤º
                    } else {
                        
                    }
                }

                // è¯»å–ä»Šæ—¥è®°å½•
                const { data: logsData, error: logsError } = await supabaseClient
                    .from('daily_logs')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .eq('log_date', today)
                    .single();

                if (logsData) {
                    
                    
                    // æ¯”è¾ƒæ—¶é—´æˆ³
                    const cloudUpdatedAt = new Date(logsData.updated_at).getTime();
                    const localUpdatedAt = parseInt(localStorage.getItem('queertime-logs-updated') || '0');
                    
                    if (cloudUpdatedAt > localUpdatedAt) {
                        
                        todayLogs.work = logsData.work;
                        todayLogs.rest = logsData.rest;
                        todayLogs.create = logsData.create_time;
                        todayLogs.exercise = logsData.exercise;
                        todayLogs.social = logsData.social;
                        todayLogs.read = logsData.read;
                        allData[today] = todayLogs;
                        localStorage.setItem('queertime-all', JSON.stringify(allData));
                    } else {
                        
                    }
                }

                // è¿›è¡Œä¸­æ´»åŠ¨åªç”¨æœ¬åœ°å­˜å‚¨ï¼Œä¸ä»äº‘ç«¯æ¢å¤ï¼ˆé¿å…åŒæ­¥å†²çªï¼‰
                // æœ¬åœ°æ¢å¤å·²ç»åœ¨ restoreFromLocal() å¤„ç†äº†

                updateDisplay();
                updateBalanceBars();
                // å¦‚æœæœ‰æ´»åŠ¨è¿›è¡Œä¸­ï¼Œæ›´æ–°æ´»åŠ¨é¢œè‰²ï¼Œå¦åˆ™æ›´æ–°çŠ¶æ€
                if (isRunning && selectedActivity) {
                    updateCreatureActivity(selectedActivity);
                } else {
                    updateCreatureState();
                }

                syncStatus.textContent = t('synced');
                syncStatus.className = 'sync-status';
            } catch (error) {
                console.error('åŠ è½½å¤±è´¥:', error);
                syncStatus.textContent = '';
            }
        }

        async function saveOngoingToCloud() {
            // è¿›è¡Œä¸­æ´»åŠ¨åªç”¨æœ¬åœ°å­˜å‚¨ï¼Œäº‘ç«¯åŒæ­¥å¤ªå¤æ‚å®¹æ˜“å‡ºé”™
            // æœ¬åœ°å­˜å‚¨å·²ç»åœ¨å¼€å§‹æ´»åŠ¨æ—¶å¤„ç†äº†
            return;
        }

        // ==================== åˆå§‹åŒ– ====================
        
        // æ¢å¤è¿›è¡Œä¸­æ´»åŠ¨çš„å‡½æ•°
        function restoreOngoingActivity(activity, activityStartTime, activityTargetMinutes) {
            
            
            if (isRunning) {
                
                return;
            }
            
            const elapsedMinutes = Math.floor((Date.now() - activityStartTime) / 1000 / 60);
            
            
            if (elapsedMinutes >= 480) {
                
                return;
            }
            
            
            selectedActivity = activity;
            startTime = activityStartTime;
            targetMinutes = activityTargetMinutes;
            isRunning = true;
            
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            timerSettings.style.display = 'none';
            
            document.querySelectorAll('.activity-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.activity-btn[data-type="${activity}"]`)?.classList.add('active');
            
            updateCreatureActivity(activity);
            const activityKey = { work: 'work', rest: 'rest', create: 'create', exercise: 'exercise', social: 'social', read: 'read' };
            currentActivity.textContent = `${t(activityKey[activity])}...`;
            statusMessage.textContent = `${t('welcomeBack')}${t(activityKey[activity])}${t('ongoing')}`;
            
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
        }

        // ä»æœ¬åœ°æ¢å¤è¿›è¡Œä¸­çš„æ´»åŠ¨
        function restoreFromLocal() {
            const ongoing = JSON.parse(localStorage.getItem('queertime-ongoing'));
            
            if (ongoing && ongoing.startTime) {
                
                restoreOngoingActivity(ongoing.activity, ongoing.startTime, ongoing.targetMinutes);
                return true;
            }
            return false;
        }

        // å…ˆå°è¯•ä»æœ¬åœ°æ¢å¤ï¼ˆä¸ç®¡æ˜¯å¦ç™»å½•ï¼‰
        const restoredFromLocal = restoreFromLocal();
        

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        let hasSyncedOnLoad = false;
        supabaseClient.auth.getSession().then(({ data: { session } }) => {
            if (session) {
                currentUser = session.user;
                
                updateAuthUI();
                // ç™»å½•ç”¨æˆ·ï¼šåŒæ­¥äº‘ç«¯æ•°æ®
                if (!hasSyncedOnLoad) {
                    hasSyncedOnLoad = true;
                    syncFromCloud();
                }
                // å¦‚æœæœ‰æœ¬åœ°è¿›è¡Œä¸­çš„æ´»åŠ¨ï¼Œä¿å­˜åˆ°äº‘ç«¯
                if (isRunning) {
                    
                    saveOngoingToCloud();
                }
            } else {
                
            }
        });

        // ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
        supabaseClient.auth.onAuthStateChange((event, session) => {
            
            if (event === 'SIGNED_IN' && session) {
                currentUser = session.user;
                updateAuthUI();
                if (!hasSyncedOnLoad) {
                    hasSyncedOnLoad = true;
                    syncFromCloud();
                }
                // å¦‚æœæœ‰æœ¬åœ°è¿›è¡Œä¸­çš„æ´»åŠ¨ï¼Œä¿å­˜åˆ°äº‘ç«¯
                if (isRunning) {
                    
                    saveOngoingToCloud();
                }
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                updateAuthUI();
            }
        });

        // æ£€æŸ¥å¤šä¹…æ²¡äº’åŠ¨ï¼Œè¿æ¥å€¼ä¸‹é™
        const lastInteraction = state.lastInteraction || Date.now();
        const hoursSinceInteraction = (Date.now() - lastInteraction) / 1000 / 60 / 60;
        if (hoursSinceInteraction > 6) {
            // è¶…è¿‡6å°æ—¶æ²¡äº’åŠ¨ï¼Œè¿æ¥ä¸‹é™
            const decrease = Math.min(state.bonding, Math.floor(hoursSinceInteraction * 3)); // æ¯å°æ—¶æ‰3%
            state.bonding = Math.max(0, state.bonding - decrease);
        }
        state.lastVisit = Date.now();
        saveStateLocal();

        // æ›´æ–°äº’åŠ¨æ—¶é—´çš„å‡½æ•°
        function recordInteraction() {
            state.lastInteraction = Date.now();
            saveStateLocal();
        }

        // åˆå§‹åŒ–è¯­è¨€
        setLanguage(currentLang);

        // è¯­è¨€åˆ‡æ¢æŒ‰é’®
        document.getElementById('lang-btn').addEventListener('click', () => {
            setLanguage(currentLang === 'zh' ? 'en' : 'zh');
        });

        updateDisplay();
        updateBalanceBars();
        updateCreatureState();
        startIdleActions();

        // ç‚¹å‡»å® ç‰©
        creatureContainer.addEventListener('click', () => {
            creature.classList.add('noticed-you');
            statusMessage.textContent = getClickResponse();
            
            setTimeout(() => {
                creature.classList.remove('noticed-you');
                updateCreatureState();
            }, 1000);
        });

        // ==================== æ´»åŠ¨æŒ‰é’® ====================
        document.querySelectorAll('.activity-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (isRunning) return;
                document.querySelectorAll('.activity-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedActivity = btn.dataset.type;
            });
        });

        // ==================== å¼€å§‹/ç»“æŸ ====================
        startBtn.addEventListener('click', () => {
            if (!selectedActivity) {
                statusMessage.textContent = t('selectActivity');
                return;
            }
            
            isRunning = true;
            startTime = Date.now();
            targetMinutes = timerInput.value ? parseInt(timerInput.value) : null;
            
            
            
            // ä¿å­˜è¿›è¡Œä¸­çš„æ´»åŠ¨
            const ongoingData = {
                activity: selectedActivity,
                startTime: startTime,
                targetMinutes: targetMinutes
            };
            localStorage.setItem('queertime-ongoing', JSON.stringify(ongoingData));
            
            
            saveOngoingToCloud();
            
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            timerSettings.style.display = 'none';
            
            updateCreatureActivity(selectedActivity);
            
            currentActivity.textContent = `${t(selectedActivity)}...`;
            statusMessage.textContent = getActivityMessage(selectedActivity);
            
            timerInterval = setInterval(updateTimer, 1000);
        });

        stopBtn.addEventListener('click', () => {
            endActivity();
        });

        // ==================== é‡ç½®å’Œå¯¼å‡º ====================
        resetBtn.addEventListener('click', () => {
            if (confirm(t('confirmReset'))) {
                todayLogs = { work: 0, rest: 0, create: 0, exercise: 0, social: 0, read: 0 };
                allData[today] = todayLogs;
                localStorage.setItem('queertime-all', JSON.stringify(allData));
                updateBalanceBars();
                updateCreatureState();
                syncToCloud();
            }
        });

        exportBtn.addEventListener('click', () => {
            const textureData = JSON.parse(localStorage.getItem('queertime-textures') || '[]');
            const exportData = {
                history: allData,
                state: state,
                textures: textureData,
                exportedAt: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `queer-time-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // ==================== è¡¥è®°åŠŸèƒ½ ====================
        const logModal = document.getElementById('log-modal');
        const logBtn = document.getElementById('log-btn');
        const logCancel = document.getElementById('log-cancel');
        const logConfirm = document.getElementById('log-confirm');
        const logActivity = document.getElementById('log-activity');
        const logMinutes = document.getElementById('log-minutes');

        logBtn.addEventListener('click', () => {
            if (isRunning) {
                statusMessage.textContent = t('finishFirst');
                return;
            }
            logModal.style.display = 'flex';
        });

        logCancel.addEventListener('click', () => {
            logModal.style.display = 'none';
            logMinutes.value = '';
        });

        logConfirm.addEventListener('click', () => {
            const activity = logActivity.value;
            const minutes = parseInt(logMinutes.value);
            
            if (!minutes || minutes < 1) {
                alert(t('enterValidTime'));
                return;
            }
            
            // è®°å½•æ•°æ®
            todayLogs[activity] += minutes;
            allData[today] = todayLogs;
            localStorage.setItem('queertime-all', JSON.stringify(allData));
            
            // è¡¥è®°ä¹Ÿæ›´æ–°ç²¾åŠ›ï¼ˆä½†ä¸åŠ è¿æ¥ï¼‰
            updateEnergyOnly(activity, minutes);
            
            // è®°å½•äº’åŠ¨
            recordInteraction();
            
            // æ›´æ–°æ˜¾ç¤º
            updateBalanceBars();
            updateDisplay();
            
            // åŒæ­¥åˆ°äº‘
            syncToCloud();
            
            // å…³é—­å¼¹çª—
            logModal.style.display = 'none';
            logMinutes.value = '';
            
            statusMessage.textContent = t('logged');
            setTimeout(() => updateCreatureState(), 1500);
        });

        // ç‚¹å‡»é®ç½©å…³é—­
        logModal.addEventListener('click', (e) => {
            if (e.target === logModal) {
                logModal.style.display = 'none';
                logMinutes.value = '';
            }
        });

        // ==================== å…³äºå¼¹çª— ====================
        const aboutModal = document.getElementById('about-modal');
        const aboutBtn = document.getElementById('about-btn');
        const aboutClose = document.getElementById('about-close');

        aboutBtn.addEventListener('click', () => {
            aboutModal.style.display = 'flex';
        });

        aboutClose.addEventListener('click', () => {
            aboutModal.style.display = 'none';
        });

        aboutModal.addEventListener('click', (e) => {
            if (e.target === aboutModal) {
                aboutModal.style.display = 'none';
            }
        });

        // ==================== æ ¸å¿ƒå‡½æ•° ====================
        
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            // å®šæ—¶åˆ°äº†
            if (targetMinutes && minutes >= targetMinutes) {
                playNotification();
                endActivity();
            }
        }

        function endActivity() {
            if (!isRunning) return;
            
            clearInterval(timerInterval);
            
            // æ¸…é™¤è¿›è¡Œä¸­æ´»åŠ¨çš„ä¿å­˜
            localStorage.removeItem('queertime-ongoing');
            
            // è®¡ç®—æ—¶é—´
            const elapsedMinutes = Math.max(1, Math.floor((Date.now() - startTime) / 1000 / 60));
            
            
            
            
            // è®°å½•æ´»åŠ¨
            const finishedActivity = selectedActivity;
            todayLogs[selectedActivity] += elapsedMinutes;
            allData[today] = todayLogs;
            localStorage.setItem('queertime-all', JSON.stringify(allData));
            
            
            
            // æ›´æ–°ç²¾åŠ›å’Œè¿æ¥
            updateEnergyAndBonding(selectedActivity, elapsedMinutes);
            
            
            
            // è®°å½•äº’åŠ¨
            recordInteraction();
            
            // é‡ç½®UI
            isRunning = false;
            startTime = null;
            targetMinutes = null;
            startBtn.style.display = 'inline-block';
            stopBtn.style.display = 'none';
            timerSettings.style.display = 'flex';
            timerDisplay.textContent = '00:00';
            currentActivity.textContent = '';
            timerInput.value = '';
            
            document.querySelectorAll('.activity-btn').forEach(b => b.classList.remove('active'));
            selectedActivity = null;
            
            updateBalanceBars();
            updateDisplay();
            updateCreatureState();
            
            // æ˜¾ç¤ºæ—¶é—´è´¨åœ°é¢œè‰²é€‰æ‹©å™¨
            showTexturePicker(finishedActivity, elapsedMinutes);
            
            // åŒæ­¥åˆ°äº‘
            syncToCloud();
            saveOngoingToCloud();
        }

        // æ—¶é—´çš„è´¨åœ° & å…±åœ¨ï¼ˆå…±ç”¨é¢œè‰²é€‰æ‹©å™¨ï¼‰
        const texturePicker = document.getElementById('texture-picker');
        let textureTimeout = null;
        let currentTextureActivity = null;
        let currentTextureMinutes = 0;
        let pickerMode = 'texture'; // 'texture' æˆ– 'checkin'

        function showTexturePicker(activity, minutes) {
            pickerMode = 'texture';
            currentTextureActivity = activity;
            currentTextureMinutes = minutes;
            
            texturePicker.classList.add('show');
            statusMessage.textContent = t('texturePrompt');
            
            // 4ç§’åè‡ªåŠ¨æ¶ˆå¤±
            textureTimeout = setTimeout(() => {
                hideTexturePicker();
            }, 4000);
        }

        function showCheckinPicker() {
            if (texturePicker.classList.contains('show')) return; // å·²ç»æ˜¾ç¤ºäº†
            
            pickerMode = 'checkin';
            currentTextureActivity = null;
            currentTextureMinutes = 0;
            
            texturePicker.classList.add('show');
            statusMessage.textContent = t('checkinPrompt');
            
            // å…±åœ¨æ¨¡å¼ä¸è‡ªåŠ¨æ¶ˆå¤±ï¼Œç­‰ç”¨æˆ·é€‰æ‹©æˆ–ç‚¹åˆ«å¤„
        }

        function hideTexturePicker() {
            if (textureTimeout) {
                clearTimeout(textureTimeout);
                textureTimeout = null;
            }
            texturePicker.classList.add('fade-out');
            setTimeout(() => {
                texturePicker.classList.remove('show', 'fade-out');
                if (!isRunning) {
                    updateCreatureState();
                }
            }, 300);
        }

        // å…±åœ¨æŒ‰é’®
        const checkinBtn = document.getElementById('checkin-btn');
        checkinBtn.addEventListener('click', () => {
            if (isRunning) {
                // æ´»åŠ¨è¿›è¡Œä¸­ä¹Ÿå¯ä»¥å…±åœ¨
            }
            showCheckinPicker();
        });

        // ä»€ä¹ˆéƒ½åšä¸äº†æŒ‰é’®
        const stuckBtn = document.getElementById('stuck-btn');
        stuckBtn.addEventListener('click', () => {
            if (isRunning) {
                statusMessage.textContent = t('finishFirst');
                return;
            }
            
            // å°çƒå˜æˆç–²æƒ«çŠ¶æ€
            creature.className = 'creature tired';
            
            // æ˜¾ç¤ºæ¸©æŸ”çš„æ¶ˆæ¯
            const stuckMsgs = t('stuckMsgs');
            statusMessage.textContent = stuckMsgs[Math.floor(Math.random() * stuckMsgs.length)];
            
            // æ˜¾ç¤ºé¢œè‰²é€‰æ‹©å™¨
            pickerMode = 'stuck';
            texturePicker.classList.add('show');
            
            // è¿æ¥+2ï¼ˆä½ æ‰¿è®¤äº†è‡ªå·±çš„çŠ¶æ€ï¼‰
            state.bonding = Math.min(100, state.bonding + 2);
            updateDisplay();
            
            // è®°å½•äº’åŠ¨
            recordInteraction();
            
            // ä¿å­˜è¿™ä¸ªçŠ¶æ€
            saveStuck();
            syncToCloud();
        });

        function saveStuck() {
            const textureData = JSON.parse(localStorage.getItem('queertime-textures') || '[]');
            textureData.push({
                type: 'stuck',
                date: today,
                timestamp: Date.now()
            });
            localStorage.setItem('queertime-textures', JSON.stringify(textureData));
        }

        // é¢œè‰²é€‰æ‹©
        document.querySelectorAll('.texture-color').forEach(colorBtn => {
            colorBtn.addEventListener('click', () => {
                const color = colorBtn.dataset.color;
                
                if (pickerMode === 'texture') {
                    // æ—¶é—´è´¨åœ°æ¨¡å¼
                    saveTexture(currentTextureActivity, currentTextureMinutes, color);
                    
                    // æ ¹æ®é¢œè‰²è°ƒæ•´ç²¾åŠ›
                    adjustEnergyByColor(color, currentTextureMinutes);
                    
                    statusMessage.textContent = t('noted');
                    
                    // é€‰äº†é¢œè‰²ï¼Œè¿æ¥ +2
                    state.bonding = Math.min(100, state.bonding + 2);
                } else if (pickerMode === 'checkin') {
                    // å…±åœ¨æ¨¡å¼
                    saveCheckin(color);
                    statusMessage.textContent = t('present');
                    
                    // é€‰äº†é¢œè‰²ï¼Œè¿æ¥ +2
                    state.bonding = Math.min(100, state.bonding + 2);
                    
                    // è®°å½•äº’åŠ¨
                    recordInteraction();
                } else if (pickerMode === 'stuck') {
                    // ä»€ä¹ˆéƒ½åšä¸äº†æ¨¡å¼ - æ›´æ–°æœ€åä¸€æ¡ stuck è®°å½•çš„é¢œè‰²
                    updateStuckColor(color);
                    statusMessage.textContent = t('noted');
                    // stuck ç‚¹å‡»æ—¶å·²ç»åŠ è¿‡è¿æ¥äº†ï¼Œè¿™é‡Œä¸é‡å¤åŠ 
                }
                
                updateDisplay();
                syncToCloud();
                
                // å°çƒå¸æ”¶é¢œè‰²çš„è§†è§‰æ•ˆæœ
                const colorMap = {
                    red: '#e74c3c',
                    orange: '#e67e22', 
                    yellow: '#f1c40f',
                    green: '#2ecc71',
                    cyan: '#1abc9c',
                    blue: '#3498db',
                    purple: '#9b59b6'
                };
                creature.style.setProperty('--absorb-color', colorMap[color]);
                creature.classList.add('absorbing');
                setTimeout(() => creature.classList.remove('absorbing'), 800);
                
                // éšè—é€‰æ‹©å™¨
                hideTexturePicker();
            });
        });

        function updateStuckColor(color) {
            const textureData = JSON.parse(localStorage.getItem('queertime-textures') || '[]');
            // æ‰¾åˆ°æœ€åä¸€æ¡ stuck è®°å½•å¹¶æ›´æ–°é¢œè‰²
            for (let i = textureData.length - 1; i >= 0; i--) {
                if (textureData[i].type === 'stuck' && !textureData[i].color) {
                    textureData[i].color = color;
                    break;
                }
            }
            localStorage.setItem('queertime-textures', JSON.stringify(textureData));
        }

        // ç‚¹å‡»åˆ«å¤„å…³é—­é€‰æ‹©å™¨ï¼ˆå…±åœ¨å’Œä»€ä¹ˆéƒ½åšä¸äº†ï¼‰
        document.addEventListener('click', (e) => {
            if ((pickerMode === 'checkin' || pickerMode === 'stuck') && 
                texturePicker.classList.contains('show') &&
                !texturePicker.contains(e.target) &&
                e.target !== checkinBtn &&
                e.target !== stuckBtn) {
                hideTexturePicker();
            }
        });

        function saveTexture(activity, minutes, color) {
            // ä¿å­˜åˆ°æœ¬åœ°
            const textureData = JSON.parse(localStorage.getItem('queertime-textures') || '[]');
            textureData.push({
                type: 'texture',
                date: today,
                activity: activity,
                minutes: minutes,
                color: color,
                timestamp: Date.now()
            });
            localStorage.setItem('queertime-textures', JSON.stringify(textureData));
        }

        function saveCheckin(color) {
            // ä¿å­˜åˆ°æœ¬åœ°
            const textureData = JSON.parse(localStorage.getItem('queertime-textures') || '[]');
            textureData.push({
                type: 'checkin',
                date: today,
                color: color,
                timestamp: Date.now()
            });
            localStorage.setItem('queertime-textures', JSON.stringify(textureData));
        }

        function updateEnergyAndBonding(activity, minutes) {
            // æ›´æ–°ç²¾åŠ›
            updateEnergyOnly(activity, minutes);
            
            // è¿æ¥å˜åŒ–ï¼ˆé¢œè‰²é€‰æ‹©æ—¶é¢å¤–åŠ ï¼Œè¿™é‡Œæ˜¯åŸºç¡€çš„ï¼‰
            if (state.energy > 35) {
                state.bonding = Math.min(100, state.bonding + Math.floor(minutes / 3));
            } else {
                if (activity === 'rest') {
                    state.bonding = Math.min(100, state.bonding + Math.floor(minutes / 2));
                }
            }
            
            saveStateLocal();
        }

        // åªæ›´æ–°ç²¾åŠ›ï¼Œä¸æ›´æ–°è¿æ¥ï¼ˆç”¨äºè¡¥è®°ï¼‰
        function updateEnergyOnly(activity, minutes) {
            if (activity === 'rest') {
                // ä¼‘æ¯æ¢å¤ç²¾åŠ›ï¼ˆæ¯5åˆ†é’Ÿ+1ï¼‰
                state.energy = Math.min(100, state.energy + Math.floor(minutes / 5));
            } else if (activity === 'exercise') {
                // è¿åŠ¨ï¼šè½»å¾®æ¢å¤ï¼ˆæ¯8åˆ†é’Ÿ+1ï¼‰
                state.energy = Math.min(100, state.energy + Math.floor(minutes / 8));
            } else {
                // å…¶ä»–æ´»åŠ¨éƒ½æ¶ˆè€—ç²¾åŠ›
                const types = ['work', 'rest', 'create', 'exercise', 'social', 'read'];
                const activeTypes = types.filter(t => todayLogs[t] > 0).length;
                
                if (activeTypes >= 3) {
                    // å¤šæ ·æ€§å¥½ï¼Œæ¶ˆè€—æ…¢
                    state.energy = Math.max(0, state.energy - Math.floor(minutes / 8));
                } else {
                    // å•ä¸€æ´»åŠ¨ï¼Œæ¶ˆè€—å¿«
                    state.energy = Math.max(0, state.energy - Math.floor(minutes / 5));
                }
            }
            
            saveStateLocal();
        }
        
        // æ ¹æ®é¢œè‰²è°ƒæ•´ç²¾åŠ›ï¼ˆæ´»åŠ¨ç»“æŸé€‰é¢œè‰²æ—¶è°ƒç”¨ï¼‰
        function adjustEnergyByColor(color, minutes) {
            const warmColors = ['red', 'orange', 'yellow'];
            const coolColors = ['cyan', 'blue', 'purple'];
            
            if (warmColors.includes(color)) {
                // æš–è‰²ï¼šæ¿€çƒˆ/ç´§å¼ ï¼Œé¢å¤–æ¶ˆè€—ä¸€ç‚¹
                state.energy = Math.max(0, state.energy - Math.floor(minutes / 10));
            } else if (coolColors.includes(color)) {
                // å†·è‰²ï¼šå¹³é™/æ”¾æ¾ï¼Œæ¢å¤ä¸€ç‚¹
                state.energy = Math.min(100, state.energy + Math.floor(minutes / 10));
            }
            // ç»¿è‰²ï¼šä¸­æ€§ï¼Œä¸é¢å¤–è°ƒæ•´
            
            saveStateLocal();
        }

        function updateDisplay() {
            energyDisplay.textContent = `${Math.round(state.energy)}%`;
            bondingDisplay.textContent = `${Math.round(state.bonding)}%`;
        }

        function updateCreatureState() {
            creature.className = 'creature';
            
            const energy = state.energy;
            const bonding = state.bonding;
            
            const isLowEnergy = energy < 35;
            const hasConnection = bonding > 30;
            
            if (!isLowEnergy && hasConnection) {
                creature.classList.add('happy');
                statusMessage.textContent = getHappyMessage();
            } else if (!isLowEnergy && !hasConnection) {
                statusMessage.textContent = getCuriousMessage();
            } else if (isLowEnergy && hasConnection) {
                creature.classList.add('tired');
                statusMessage.textContent = getWorriedMessage();
            } else {
                creature.classList.add('tired');
                statusMessage.textContent = getUpsetMessage();
            }
        }

        function updateCreatureActivity(activity) {
            creature.className = 'creature';
            switch(activity) {
                case 'work': creature.classList.add('working'); break;
                case 'rest': creature.classList.add('resting'); break;
                case 'create': creature.classList.add('creating'); break;
                case 'exercise': creature.classList.add('exercising'); break;
                case 'social': creature.classList.add('socializing'); break;
                case 'read': creature.classList.add('reading'); break;
            }
        }

        function updateBalanceBars() {
            const total = Math.max(1, Object.values(todayLogs).reduce((a, b) => a + b, 0));
            const types = ['work', 'rest', 'create', 'exercise', 'social', 'read'];
            
            types.forEach(type => {
                const bar = document.getElementById(`bar-${type}`);
                const time = document.getElementById(`time-${type}`);
                const minutes = todayLogs[type] || 0;
                const percentage = (minutes / total) * 100;
                
                bar.style.width = `${percentage}%`;
                time.textContent = `${minutes}åˆ†`;
            });
        }

        // ==================== å°åŠ¨ä½œ ====================
        function startIdleActions() {
            idleActionInterval = setInterval(() => {
                if (isRunning) return;
                
                const rand = Math.random();
                
                if (rand < 0.25) {
                    const eyes = creature.querySelectorAll('.eye');
                    eyes[0].style.transform = 'translateX(-4px)';
                    eyes[1].style.transform = 'translateX(4px)';
                    setTimeout(() => {
                        eyes[0].style.transform = '';
                        eyes[1].style.transform = '';
                    }, 1500);
                } else if (rand < 0.5) {
                    const eyes = creature.querySelectorAll('.eye');
                    eyes.forEach(eye => {
                        eye.style.transform = 'scaleY(0.1)';
                    });
                    setTimeout(() => {
                        eyes.forEach(eye => eye.style.transform = '');
                    }, 150);
                    setTimeout(() => {
                        eyes.forEach(eye => eye.style.transform = 'scaleY(0.1)');
                        setTimeout(() => eyes.forEach(eye => eye.style.transform = ''), 150);
                    }, 300);
                } else if (rand < 0.7) {
                    creature.style.boxShadow = '0 0 100px rgba(168, 216, 234, 0.8)';
                    setTimeout(() => creature.style.boxShadow = '', 800);
                } else if (rand < 0.85) {
                    const idleMsgs = t('idleMsgs');
                    statusMessage.textContent = idleMsgs[Math.floor(Math.random() * idleMsgs.length)];
                    setTimeout(() => {
                        if (!isRunning) updateCreatureState();
                    }, 2000);
                } else {
                    creature.style.width = '130px';
                    creature.style.height = '130px';
                    setTimeout(() => {
                        creature.style.width = '';
                        creature.style.height = '';
                    }, 500);
                }
                
            }, 3000 + Math.random() * 2000);
        }

        // ==================== æ¶ˆæ¯ ====================
        function getActivityMessage(activity) {
            const keys = {
                work: 'msgWork',
                rest: 'msgRest',
                create: 'msgCreate',
                exercise: 'msgExercise',
                social: 'msgSocial',
                read: 'msgRead'
            };
            return t(keys[activity]);
        }

        function getHappyMessage() {
            const messages = t('happyMsgs');
            return messages[Math.floor(Math.random() * messages.length)];
        }

        function getCuriousMessage() {
            const messages = t('curiousMsgs');
            return messages[Math.floor(Math.random() * messages.length)];
        }

        function getWorriedMessage() {
            const messages = t('worriedMsgs');
            return messages[Math.floor(Math.random() * messages.length)];
        }

        function getUpsetMessage() {
            const messages = t('upsetMsgs');
            return messages[Math.floor(Math.random() * messages.length)];
        }

        function getClickResponse() {
            const bonding = state.bonding;
            
            if (bonding > 50) {
                const msgs = t('clickHighBond');
                return msgs[Math.floor(Math.random() * msgs.length)];
            } else if (bonding > 20) {
                const msgs = t('clickMidBond');
                return msgs[Math.floor(Math.random() * msgs.length)];
            } else {
                const msgs = t('clickLowBond');
                return msgs[Math.floor(Math.random() * msgs.length)];
            }
        }

        // ==================== æé†’ ====================
        function playNotification() {
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
            
            creature.classList.add('timer-done');
            statusMessage.textContent = t('timeUp');
            
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 440;
                oscillator.type = 'sine';
                gainNode.gain.value = 0.3;
                
                oscillator.start();
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('æ— æ³•æ’­æ”¾å£°éŸ³');
            }
            
            setTimeout(() => {
                creature.classList.remove('timer-done');
            }, 2000);
        }

        // ==================== ä¿å­˜ ====================
        function saveStateLocal() {
            state.lastVisit = Date.now();
            localStorage.setItem('queertime-state', JSON.stringify(state));
        }

        // é¡µé¢å…³é—­å‰ä¿å­˜
        window.addEventListener('beforeunload', () => {
            saveStateLocal();
            if (currentUser) {
                // å°è¯•åŒæ­¥ï¼ˆä¸ç­‰å¾…ï¼‰
                navigator.sendBeacon && syncToCloud();
            }
        });

        // é¡µé¢å¯è§æ€§å˜åŒ–æ—¶åŒæ­¥ï¼ˆä½†ä¸æ˜¯é¦–æ¬¡åŠ è½½ï¼‰
        let pageLoadTime = Date.now();
        document.addEventListener('visibilitychange', () => {
            // è‡³å°‘5ç§’åæ‰è§¦å‘ï¼ˆé¿å…é¦–æ¬¡åŠ è½½æ—¶é‡å¤åŒæ­¥ï¼‰
            if (document.visibilityState === 'visible' && currentUser && Date.now() - pageLoadTime > 5000) {
                
                syncFromCloud();
            }
        });
    </script>
</body>
</html>
